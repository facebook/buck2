"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[62476],{28453:(o,n,e)=>{e.d(n,{R:()=>l,x:()=>c});var i=e(96540);const s={},t=i.createContext(s);function l(o){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof o?o(n):{...n,...o}},[n,o])}function c(o){let n;return n=o.disableParentContext?"function"==typeof o.components?o.components(s):o.components||s:l(o.components),i.createElement(t.Provider,{value:n},o.children)}},63472:(o,n,e)=>{e.r(n),e.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>r});const i=JSON.parse('{"id":"users/languages/go/toolchains","title":"Toolchains","description":"Go toolchains in Buck2 come in two types: \\"regular\\" and \\"bootstrap\\".","source":"@site/../docs/users/languages/go/toolchains.md","sourceDirName":"users/languages/go","slug":"/users/languages/go/toolchains","permalink":"/docs/users/languages/go/toolchains","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"toolchains","title":"Toolchains"},"sidebar":"main","previous":{"title":"Overview","permalink":"/docs/users/languages/go/overview"},"next":{"title":"Third-Party Packages","permalink":"/docs/users/languages/go/third_party_packages"}}');var s=e(74848),t=e(28453);const l={id:"toolchains",title:"Toolchains"},c="Toolchains",a={},r=[{value:"Hermetic Toolchains (Recommended)",id:"hermetic-toolchains-recommended",level:2},{value:"Toolchain Locations",id:"toolchain-locations",level:3},{value:"Example Configuration",id:"example-configuration",level:3},{value:"Advanced: Multi-platform Toolchains",id:"advanced-multi-platform-toolchains",level:3},{value:"System Toolchains",id:"system-toolchains",level:2},{value:"Toolchain Locations",id:"toolchain-locations-1",level:3},{value:"Example Configuration",id:"example-configuration-1",level:3}];function d(o){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...o.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"toolchains",children:"Toolchains"})}),"\n",(0,s.jsx)(n.p,{children:'Go toolchains in Buck2 come in two types: "regular" and "bootstrap".'}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Regular toolchains"})," are used to build Go code."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Bootstrap toolchains"})," are used to build the tools required to build Go\ncode."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["A minimal setup requires ",(0,s.jsx)(n.code,{children:":go"}),", ",(0,s.jsx)(n.code,{children:":go_bootstrap"}),", and ",(0,s.jsx)(n.code,{children:":python_bootstrap"})," in your\n",(0,s.jsx)(n.code,{children:"toolchains//"})," cell."]}),"\n",(0,s.jsxs)(n.p,{children:["Additionally, a ",(0,s.jsx)(n.code,{children:":cxx"})," toolchain is required:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"If you use CGo, you need a fully configured CXX toolchain"}),"\n",(0,s.jsxs)(n.li,{children:["If you don't use CGo, you can define it with a stub ",(0,s.jsx)(n.code,{children:"no_toolchain"})," rule"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:'Each type of Go toolchain has two implementations: "system" and "hermetic".'}),"\n",(0,s.jsx)(n.h2,{id:"hermetic-toolchains-recommended",children:"Hermetic Toolchains (Recommended)"}),"\n",(0,s.jsx)(n.p,{children:"Hermetic toolchains are the recommended way to build Go code because they:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Make builds reproducible"}),"\n",(0,s.jsx)(n.li,{children:"Support all features of the Go rules"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Hermetic toolchains consist of two rules: ",(0,s.jsx)(n.code,{children:"go*_distr"})," and ",(0,s.jsx)(n.code,{children:"go*_toolchain"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"*_distr"})," rules wrap Go distributions produced by ",(0,s.jsx)(n.code,{children:"go tool dist"}),", such as\nthose available at ",(0,s.jsx)(n.a,{href:"https://go.dev/dl/",children:"go.dev/dl"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["You can use either local or ",(0,s.jsx)(n.code,{children:"http_archive"})," Go distributions."]}),"\n",(0,s.jsx)(n.h3,{id:"toolchain-locations",children:"Toolchain Locations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"@prelude//toolchains/go:go_toolchain.bzl"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"@prelude//toolchains/go:go_bootstrap_toolchain.bzl"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-configuration",children:"Example Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["Here's an example of ",(0,s.jsx)(n.code,{children:"go_toolchain"})," using local Go distributions\n(",(0,s.jsx)(n.code,{children:"go_bootstrap_toolchain"})," is defined similarly):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'load("@prelude//toolchains/go:go_toolchain.bzl", "go_distr", "go_toolchain")\n\n# Note: selects are resolved against execution-platform\ngo_distr(\n    name = "go_distr",\n    go_os_arch = select({\n        "config//os:linux": select({"config//cpu:x86_64": ("linux", "amd64")}),\n        "config//os:macos": select({"config//cpu:arm64": ("darwin", "arm64")}),\n    }),\n    go_root = select({\n        "config//os:linux": select({"config//cpu:x86_64": "path/to/go-linux-amd64"}),\n        "config//os:macos": select({"config//cpu:arm64": "path/to/go-darwin-arm64"}),\n    }),\n    version = "1.X.Y",\n)\n\n# Note: selects are resolved against target-platform\ngo_toolchain(\n    name = "go",\n    env_go_arch = select({\n        "config//cpu:arm64": "arm64",\n        "config//cpu:x86_64": "amd64",\n    }),\n    env_go_os = select({\n        "config//os:linux": "linux",\n        "config//os:macos": "darwin",\n        "config//os:windows": "windows",\n    }),\n    go_distr = ":go_distr",\n    visibility = ["PUBLIC"],\n)\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For a complete example using ",(0,s.jsx)(n.code,{children:"http_archive"}),", see\n",(0,s.jsx)(n.a,{href:"https://github.com/facebook/buck2/blob/main/examples/toolchains/go_toolchain/toolchains/BUCK",children:"examples/toolchains/go_toolchain"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"advanced-multi-platform-toolchains",children:"Advanced: Multi-platform Toolchains"}),"\n",(0,s.jsxs)(n.p,{children:["If you support multiple execution platforms using standard Go distributions\n(produced by ",(0,s.jsx)(n.code,{children:"go tool dist"}),"), you may encounter a situation where you have\nmultiple copies of the Go distribution with almost identical content."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"go_distr"})," rule supports a non-standard layout of the Go distribution,\nallowing you to maintain a single copy of the source code with ",(0,s.jsx)(n.code,{children:"bin"})," and\n",(0,s.jsx)(n.code,{children:"pkg/tool"})," directories containing binaries for all execution platforms you\nsupport."]}),"\n",(0,s.jsxs)(n.p,{children:["Set ",(0,s.jsx)(n.code,{children:"multiplatform = True"})," on ",(0,s.jsx)(n.code,{children:"go_distr"})," to enable this behavior. In this case,\nthe ",(0,s.jsx)(n.code,{children:"bin"})," and ",(0,s.jsx)(n.code,{children:"pkg/tool"})," directories must contain binaries in ",(0,s.jsx)(n.code,{children:"goos_goarch"}),"\nsubdirectories (built for the corresponding platforms)."]}),"\n",(0,s.jsx)(n.p,{children:"See the example for a Go distribution supporting two execution platforms:\nlinux/amd64 and darwin/arm64."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"third-party/go/1.25.1\n\u251c\u2500\u2500 api\n\u251c\u2500\u2500 bin\n\u2502\xa0\xa0 \u251c\u2500\u2500 darwin_arm64\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 go\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 gofmt\n\u2502\xa0\xa0 \u2514\u2500\u2500 linux_amd64\n\u2502\xa0\xa0     \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 ...\n\u251c\u2500\u2500 pkg\n\u2502   \u251c\u2500\u2500 include\n\u2502   \u2514\u2500\u2500 tool\n\u2502\xa0\xa0     \u251c\u2500\u2500 darwin_arm64\n\u2502\xa0\xa0     \u2502\xa0\xa0 \u251c\u2500\u2500 asm\n\u2502\xa0\xa0     \u2502\xa0\xa0 \u251c\u2500\u2500 cgo\n\u2502\xa0\xa0     \u2502\xa0\xa0 \u2514\u2500\u2500 ...\n\u2502\xa0\xa0     \u2514\u2500\u2500 linux_amd64\n\u2502\xa0\xa0         \u2514\u2500\u2500 ...\n\u2514\u2500\u2500 ...\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can produce it by downloading the ",(0,s.jsx)(n.code,{children:"src"})," distribution from ",(0,s.jsx)(n.a,{href:"https://go.dev/dl/",children:"https://go.dev/dl/"}),"\nand running the following commands (assuming you are running on ",(0,s.jsx)(n.code,{children:"linux/amd64"}),"\nand have Go installed on your system)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"$ cd distr_dir/src\n$ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 ./make.bash\n$ CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 ./make.bash\n$ mkdir ../bin/linux_amd64\n$ mv ../bin/go ../bin/linux_amd64\n$ mv ../bin/gofmt ../bin/linux_amd64\n"})}),"\n",(0,s.jsx)(n.h2,{id:"system-toolchains",children:"System Toolchains"}),"\n",(0,s.jsx)(n.p,{children:"System toolchains are not intended for production builds but can be used for\nexamples and simple projects. Note that some features of Go rules might not work\nwith system toolchains, such as building ASM files."}),"\n",(0,s.jsx)(n.h3,{id:"toolchain-locations-1",children:"Toolchain Locations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"@prelude//toolchains/go:system_go_toolchain.bzl"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"@prelude//toolchains/go:system_go_bootstrap_toolchain.bzl"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-configuration-1",children:"Example Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'load("@prelude///toolchains/go:system_go_bootstrap_toolchain.bzl", "system_go_bootstrap_toolchain")\nload("@prelude///toolchains/go:system_go_toolchain.bzl", "system_go_toolchain")\n\nsystem_go_toolchain(\n    name = "go",\n    visibility = ["PUBLIC"],\n)\n\nsystem_go_bootstrap_toolchain(\n    name = "go_bootstrap",\n    visibility = ["PUBLIC"],\n)\n'})})]})}function h(o={}){const{wrapper:n}={...(0,t.R)(),...o.components};return n?(0,s.jsx)(n,{...o,children:(0,s.jsx)(d,{...o})}):d(o)}}}]);