"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[74559],{28453:(e,o,n)=>{n.d(o,{R:()=>a,x:()=>i});var s=n(96540);const r={},t=s.createContext(r);function a(e){const o=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function i(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(t.Provider,{value:o},e.children)}},95493:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>l,contentTitle:()=>i,default:()=>g,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"users/languages/go/gopackagesdriver","title":"IDE/Tools Integration (gopackagesdriver)","description":"The Go packages driver protocol","source":"@site/../docs/users/languages/go/gopackagesdriver.md","sourceDirName":"users/languages/go","slug":"/users/languages/go/gopackagesdriver","permalink":"/docs/users/languages/go/gopackagesdriver","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"gopackagesdriver","title":"IDE/Tools Integration (gopackagesdriver)"},"sidebar":"main","previous":{"title":"Third-Party Packages","permalink":"/docs/users/languages/go/third_party_packages"},"next":{"title":"Cheat Sheet","permalink":"/docs/users/cheat_sheet"}}');var r=n(74848),t=n(28453);const a={id:"gopackagesdriver",title:"IDE/Tools Integration (gopackagesdriver)"},i="IDE/Linter Integration",l={},c=[{value:"How to use it? (golangci-lint example)",id:"how-to-use-it-golangci-lint-example",level:2},{value:"IDE Integration (gopls/VSCode)",id:"ide-integration-goplsvscode",level:2},{value:"What tools are supported?",id:"what-tools-are-supported",level:2},{value:"What tools are not supported?",id:"what-tools-are-not-supported",level:2},{value:"Configuration",id:"configuration",level:2}];function d(e){const o={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o.header,{children:(0,r.jsx)(o.h1,{id:"idelinter-integration",children:"IDE/Linter Integration"})}),"\n",(0,r.jsxs)(o.p,{children:[(0,r.jsx)(o.a,{href:"https://pkg.go.dev/golang.org/x/tools/go/packages",children:"The Go packages driver protocol"}),"\nis the standard way to integrate build systems with Go tools. Buck2 implements\nthis protocol using BXL API, enabling\n",(0,r.jsx)(o.a,{href:"https://pkg.go.dev/golang.org/x/tools/go/packages#Load",children:"golang.org/x/tools/go/packages.Load()"}),"\nbased tools to work with Buck2."]}),"\n",(0,r.jsx)(o.h2,{id:"how-to-use-it-golangci-lint-example",children:"How to use it? (golangci-lint example)"}),"\n",(0,r.jsxs)(o.p,{children:["Set the ",(0,r.jsx)(o.code,{children:"GOPACKAGESDRIVER"})," environment variable to Buck2's gopackagesdriver\nbinary path and use your Go tool as usual."]}),"\n",(0,r.jsxs)(o.p,{children:["There's no precise specification on how CLI tools should process input\narguments, but in general they should treat them as opaque. There are also query\noperators ",(0,r.jsx)(o.code,{children:"file="})," and ",(0,r.jsx)(o.code,{children:"pattern="}),"\n",(0,r.jsx)(o.a,{href:"https://pkg.go.dev/golang.org/x/tools/go/packages#pkg-overview:~:text=Two%20query%20operators%20are%20currently%20supported%3A%20%22file%22%20and%20%22pattern%22.",children:"(docs)"}),".\nSo for a package ",(0,r.jsx)(o.code,{children:'"foo/bar"'}),", one of the examples below should work."]}),"\n",(0,r.jsxs)(o.p,{children:["Let's see a ",(0,r.jsx)(o.a,{href:"https://github.com/golangci/golangci-lint",children:(0,r.jsx)(o.code,{children:"golangci-lint"})}),"\nexample:"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{children:"$ export GOPACKAGESDRIVER=$(buck2 build prelude//go/tools/gopackagesdriver:gopackagesdriver --show-full-simple-output)\n$ golangci-lint run foo/bar/baz.go\n$ golangci-lint run file=foo/bar/baz.go # use file= if previous command doesn't work\n$ golangci-lint run root//foo/bar:bar\n$ golangci-lint run pattern=root//foo/bar:bar # use pattern= if previous command doesn't work\n"})}),"\n",(0,r.jsx)(o.h2,{id:"ide-integration-goplsvscode",children:"IDE Integration (gopls/VSCode)"}),"\n",(0,r.jsxs)(o.p,{children:["Here's an example of using\n",(0,r.jsx)(o.a,{href:"https://github.com/golang/tools/tree/master/gopls",children:"gopls"})," and VSCode with\nBuck2. You can use the same approach for other IDEs and tools."]}),"\n",(0,r.jsxs)(o.ol,{children:["\n",(0,r.jsxs)(o.li,{children:["\n",(0,r.jsxs)(o.p,{children:["Install\n",(0,r.jsx)(o.a,{href:"https://marketplace.visualstudio.com/items?itemName=golang.go",children:"Go VSCode extension"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(o.li,{children:["\n",(0,r.jsxs)(o.p,{children:["Create a wrapper script ",(0,r.jsx)(o.code,{children:"tools/bin/gopackagesdriver.sh"})," inside your repo."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-sh",children:'#!/usr/bin/env bash\nexec buck2 run prelude//go/tools/gopackagesdriver:gopackagesdriver -- "${@}"\n'})}),"\n",(0,r.jsxs)(o.ol,{start:"3",children:["\n",(0,r.jsx)(o.li,{children:"Configure VSCode to use the driver."}),"\n"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-json",children:'{\n  "go.toolsEnvVars": {\n    "GOPACKAGESDRIVER": "${workspaceFolder}/tools/bin/gopackagesdriver.sh", # (required) path to the driver\n    "GOPACKAGESDRIVER_BUCK_OPTIONS": "--target-platforms prelude//platforms:default", # (optional) if your `toolchains//:go` requires it\n    "GOPACKAGESDRIVER_BUCK_ALL_PACKAGES_TARGET_EXPRS": "root//..." # (optional) index all packages on gopls startup (might be slow and unreliable)\n  },\n  "gopls": {\n    "build.workspaceFiles": [ # (required) to handle changes in BUCK files\n      "**/BUCK",\n      "**/PACKAGE",\n      "**/*.bzl",\n      "**/.buckconfig"\n    ]\n  }\n}\n'})}),"\n",(0,r.jsx)(o.h2,{id:"what-tools-are-supported",children:"What tools are supported?"}),"\n",(0,r.jsxs)(o.p,{children:["Theoretically, any tool based on\n",(0,r.jsx)(o.a,{href:"https://pkg.go.dev/golang.org/x/tools/go/packages#Load",children:(0,r.jsx)(o.code,{children:"packages.Load()"})}),"\nshould work. However, in practice, some tools may have assumptions about\nspecific build systems."]}),"\n",(0,r.jsxs)(o.p,{children:["There are\n",(0,r.jsx)(o.a,{href:"https://github.com/search?q=lang%3AGo+%22packages.Load%28%22&type=code",children:"8.2k occurrences"}),"\nof ",(0,r.jsx)(o.code,{children:"packages.Load"})," on GitHub. You can check if your favorite tool is among them.\nIf it's not working correctly, you can make a PR to adjust its behavior."]}),"\n",(0,r.jsxs)(o.p,{children:["The following tools are known to work well with ",(0,r.jsx)(o.code,{children:"GOPACKAGESDRIVER"}),":\n",(0,r.jsx)(o.a,{href:"https://github.com/golang/tools/tree/master/gopls",children:"gopls"}),",\n",(0,r.jsx)(o.a,{href:"https://github.com/golangci/golangci-lint",children:"golangci-lint"}),",\n",(0,r.jsx)(o.a,{href:"https://github.com/sourcegraph/scip-go",children:"scip-go"}),",\n",(0,r.jsx)(o.a,{href:"https://stackoverflow.com/questions/31362332/creating-call-graph/31369718#31369718",children:"callgraph"}),"."]}),"\n",(0,r.jsx)(o.h2,{id:"what-tools-are-not-supported",children:"What tools are not supported?"}),"\n",(0,r.jsxs)(o.p,{children:["Tools that directly call ",(0,r.jsx)(o.code,{children:"go list"})," or ",(0,r.jsx)(o.code,{children:"go build"})," are incompatible with this\napproach."]}),"\n",(0,r.jsx)(o.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(o.p,{children:"The driver is configured via environment variables:"}),"\n",(0,r.jsxs)(o.ul,{children:["\n",(0,r.jsxs)(o.li,{children:[(0,r.jsx)(o.code,{children:"GOPACKAGESDRIVER_BUCK_OPTIONS"})," - options passed to ",(0,r.jsx)(o.code,{children:"buck2 bxl"})," and\n",(0,r.jsx)(o.code,{children:"buck2 run"})," commands."]}),"\n",(0,r.jsxs)(o.li,{children:[(0,r.jsx)(o.code,{children:"GOPACKAGESDRIVER_BUCK_ALL_PACKAGES_TARGET_EXPRS"})," - a list of target\nexpressions separated by space, useful to replace ",(0,r.jsx)(o.code,{children:"./..."})," query that ",(0,r.jsx)(o.code,{children:"gopls"}),"\ndoes on startup."]}),"\n",(0,r.jsxs)(o.li,{children:[(0,r.jsx)(o.code,{children:"GOPACKAGESDRIVER_LOG_LEVEL"})," - log level, one of ",(0,r.jsx)(o.code,{children:"debug"}),", ",(0,r.jsx)(o.code,{children:"info"}),", ",(0,r.jsx)(o.code,{children:"warn"}),",\n",(0,r.jsx)(o.code,{children:"error"}),". Defaults to ",(0,r.jsx)(o.code,{children:"info"}),"."]}),"\n"]})]})}function g(e={}){const{wrapper:o}={...(0,t.R)(),...e.components};return o?(0,r.jsx)(o,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);