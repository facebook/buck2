"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[27809],{28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>l});var i=s(96540);const r={},o=i.createContext(r);function a(e){const n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(o.Provider,{value:n},e.children)}},41674:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"users/languages/java/jvm_abis","title":"Java/Kotlin ABIs","description":"This topic pertains to building Java code with Buck2.","source":"@site/../docs/users/languages/java/abis.md","sourceDirName":"users/languages/java","slug":"/users/languages/java/jvm_abis","permalink":"/docs/users/languages/java/jvm_abis","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"jvm_abis","title":"Java/Kotlin ABIs"},"sidebar":"main","previous":{"title":"IDE/Tools Integration (gopackagesdriver)","permalink":"/docs/users/languages/go/gopackagesdriver"},"next":{"title":"Cheat Sheet","permalink":"/docs/users/cheat_sheet"}}');var r=s(74848),o=s(28453);const a={id:"jvm_abis",title:"Java/Kotlin ABIs"},l="Java/Kotlin ABIs",t={},c=[{value:"ABI Generation Modes",id:"abi-generation-modes",level:2},{value:"Class ABI Generation",id:"class-abi-generation",level:3},{value:"Source ABI Generation",id:"source-abi-generation",level:3},{value:"Source-Only ABI Generation",id:"source-only-abi-generation",level:3},{value:"Requirements for Source-Only ABI Generation",id:"requirements-for-source-only-abi-generation",level:2},{value:"Special Attributes",id:"special-attributes",level:3},{value:"<code>source_only_abi_deps</code>",id:"source_only_abi_deps",level:4},{value:"<code>required_for_source_only_abi</code>",id:"required_for_source_only_abi",level:4},{value:"Best Practices for Source-Only ABI",id:"best-practices-for-source-only-abi",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Global Configuration",id:"global-configuration",level:3},{value:"Per-Rule Configuration",id:"per-rule-configuration",level:3},{value:"Verification",id:"verification",level:2},{value:"Performance Considerations",id:"performance-considerations",level:2}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"javakotlin-abis",children:"Java/Kotlin ABIs"})}),"\n",(0,r.jsx)(n.p,{children:"This topic pertains to building Java code with Buck2."}),"\n",(0,r.jsxs)(n.p,{children:["When compiling a Kotlin or Java rule, Buck2 creates an ",(0,r.jsx)(n.strong,{children:"Application Binary\nInterface (ABI) JAR"}),", which contains only resources and class interfaces\u2014the\npublic interface for your module. Buck2 creates this ABI JAR in addition to the\n",(0,r.jsx)(n.strong,{children:"library JAR"}),", which contains all of the compiled classes and resources for\nthe rule."]}),"\n",(0,r.jsx)(n.p,{children:"Since ABI JARs do not contain method bodies or private members, they are smaller\nand change less frequently than library JARs. This enables Buck2 to use ABI JARs\nin two important ways:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Incremental builds"})," - ABI JARs help Buck2 more accurately determine which\nrules need to be rebuilt during an incremental build. A Java/Kotlin library\nrule does not necessarily need to be rebuilt if one of its dependencies\nchanges, ",(0,r.jsx)(n.em,{children:"provided that the public interface of that dependency did not\nchange."})," This knowledge helps avoid unnecessary rebuilds."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Compilation performance"})," - ABI JARs can be used on the compiler's\nclasspath instead of library JARs. The smaller size of ABI JARs enables the\ncompiler to load them faster than library JARs, providing a performance\nboost."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"abi-generation-modes",children:"ABI Generation Modes"}),"\n",(0,r.jsxs)(n.p,{children:["Buck2 can create ABI JARs in three different ways, depending on the\n",(0,r.jsx)(n.code,{children:"abi_generation_mode"})," configuration. You can set this globally in ",(0,r.jsx)(n.code,{children:".buckconfig"}),"\nor override it per-rule using the ",(0,r.jsx)(n.code,{children:"abi_generation_mode"})," attribute."]}),"\n",(0,r.jsx)(n.h3,{id:"class-abi-generation",children:"Class ABI Generation"}),"\n",(0,r.jsx)(n.p,{children:"Builds the library JAR first and then strips out unnecessary bits (method\nbodies, private members) to create the ABI JAR."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mode value"}),": ",(0,r.jsx)(n.code,{children:"class"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Characteristics"}),": Most conservative approach, always accurate"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use when"}),": You need guaranteed correctness or have complex code that\ndoesn't work with other modes"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"source-abi-generation",children:"Source ABI Generation"}),"\n",(0,r.jsx)(n.p,{children:"Hooks into the compiler while it is compiling the library JAR and emits the ABI\nJAR partway through the compilation process."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mode value"}),": ",(0,r.jsx)(n.code,{children:"source"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Characteristics"}),": Reduces bottlenecks due to slow rules or low parallelism\nin the build graph"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use when"}),": You want better parallelism but still need compiler validation"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"source-only-abi-generation",children:"Source-Only ABI Generation"}),"\n",(0,r.jsx)(n.p,{children:"Examines only the text of the source code and uses heuristics to infer things\nthat can normally be determined only by looking at dependencies."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mode value"}),": ",(0,r.jsx)(n.code,{children:"source_only"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Characteristics"}),": Dramatically increases parallelism and reduces cache\nfetches during incremental builds"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use when"}),": You want maximum build performance and can meet the requirements\n(see below)"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"requirements-for-source-only-abi-generation",children:"Requirements for Source-Only ABI Generation"}),"\n",(0,r.jsx)(n.p,{children:"Buck2 generates source-only ABI JARs using only the text of the source code for\na rule, without first compiling most of the rule's dependencies. Some details of\nan ABI JAR cannot be known for certain from just the source, so Buck2 uses\nheuristics to infer those details."}),"\n",(0,r.jsx)(n.p,{children:"When compiling the library JAR, Buck2 verifies whether the heuristics used for\nthe ABI JAR were correct. If they were not, Buck2 fails the build with an error."}),"\n",(0,r.jsx)(n.h3,{id:"special-attributes",children:"Special Attributes"}),"\n",(0,r.jsx)(n.p,{children:"To handle cases where source-only ABI generation needs additional information,\nBuck2 provides two attributes:"}),"\n",(0,r.jsx)(n.h4,{id:"source_only_abi_deps",children:(0,r.jsx)(n.code,{children:"source_only_abi_deps"})}),"\n",(0,r.jsx)(n.p,{children:"These are dependencies that must be present during source-only ABI generation."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'java_library(\n    name = "mylib",\n    srcs = ["MyClass.java"],\n    deps = [\n        "//other:dep1",\n        "//other:dep2",\n    ],\n    source_only_abi_deps = [\n        "//other:dep1",  # This dep is needed for ABI generation\n    ],\n)\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important"}),": Having ",(0,r.jsx)(n.code,{children:"source_only_abi_deps"})," prevents Buck2 from completely\nflattening the build graph, reducing the performance win from source-only ABI\ngeneration. These should be avoided when possible. Often only a small code\nchange is needed to avoid them."]}),"\n",(0,r.jsx)(n.h4,{id:"required_for_source_only_abi",children:(0,r.jsx)(n.code,{children:"required_for_source_only_abi"})}),"\n",(0,r.jsx)(n.p,{children:"Indicates that this rule must be present on the classpath during source-only ABI\ngeneration of any rule that depends on it. Typically used for rules containing:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Annotations"}),"\n",(0,r.jsx)(n.li,{children:"Enums"}),"\n",(0,r.jsx)(n.li,{children:"Constants"}),"\n",(0,r.jsx)(n.li,{children:"Interfaces"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'java_library(\n    name = "annotations",\n    srcs = ["MyAnnotation.java"],\n    required_for_source_only_abi = True,\n)\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important"}),": Having rules marked with ",(0,r.jsx)(n.code,{children:"required_for_source_only_abi=True"}),"\nprevents Buck2 from completely flattening the build graph. These rules should be\nkept small (ideally just containing annotations, constants, enums, and\ninterfaces) and with minimal dependencies."]}),"\n",(0,r.jsx)(n.h3,{id:"best-practices-for-source-only-abi",children:"Best Practices for Source-Only ABI"}),"\n",(0,r.jsx)(n.p,{children:"To get the best performance from source-only ABI generation:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Place annotations and constants in their own rules"}),": All annotations and\ncompile-time constants (including enum values) used in the interface of a\nrule must be present during source-only ABI generation. Create small, focused\nrules for these elements with minimal dependencies."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Follow Java naming conventions"}),": Packages should have names beginning with\na lowercase letter. Top-level classes should have names beginning with an\nuppercase letter. Buck2 uses these conventions to infer which types might not\nbe available during ABI generation."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Reference member types canonically"}),": When referencing member types (nested\nclasses), use the canonical reference to the class where they are defined,\nnot a class that inherits them."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Avoid star imports"}),": Use single-type imports instead of on-demand (star)\nimports. Star imports and ",(0,r.jsx)(n.code,{children:"static"})," imports of types cannot be resolved at\nsource-ABI generation time unless the rule containing the type is available."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Minimize class hierarchy depth"}),": Deep class hierarchies split across\nmultiple modules can require additional ",(0,r.jsx)(n.code,{children:"source_only_abi_deps"}),". Keeping\nhierarchies shallow or within single modules improves ABI generation."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"global-configuration",children:"Global Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Set the default ABI generation mode in ",(0,r.jsx)(n.code,{children:".buckconfig"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",children:"[java]\n    abi_generation_mode = source_only\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Possible values: ",(0,r.jsx)(n.code,{children:"class"}),", ",(0,r.jsx)(n.code,{children:"source"}),", ",(0,r.jsx)(n.code,{children:"source_only"})]}),"\n",(0,r.jsx)(n.h3,{id:"per-rule-configuration",children:"Per-Rule Configuration"}),"\n",(0,r.jsx)(n.p,{children:"Override the global setting for a specific rule:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'java_library(\n    name = "mylib",\n    srcs = ["MyClass.java"],\n    deps = ["//other:dep"],\n    abi_generation_mode = "class",  # Override to use class ABI\n)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,r.jsx)(n.p,{children:"Buck2 supports verification modes to ensure source-only ABIs are generated\ncorrectly:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'java_library(\n    name = "mylib",\n    srcs = ["MyClass.java"],\n    source_abi_verification_mode = "fail",  # Fail build if ABI doesn\'t match\n)\n'})}),"\n",(0,r.jsx)(n.p,{children:"This compares the source-only ABI with the ABI generated from the full\ncompilation and can help identify when heuristics are incorrect."}),"\n",(0,r.jsx)(n.h2,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,r.jsx)(n.p,{children:"The performance benefits of source-only ABI generation increase with:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Build graph complexity"}),": More dependencies = more parallelism opportunities"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Incremental build frequency"}),": More frequent small changes = more cache hits"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Dependency stability"}),": Stable public interfaces = fewer rebuilds"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["However, overuse of ",(0,r.jsx)(n.code,{children:"source_only_abi_deps"})," and ",(0,r.jsx)(n.code,{children:"required_for_source_only_abi"}),"\ncan negate these benefits by reducing parallelism. Use them sparingly and keep\naffected rules small and focused."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);