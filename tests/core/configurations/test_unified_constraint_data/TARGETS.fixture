# Basic unified constraint
load("@prelude//:native.bzl", "native")
load(":defs.bzl", "unified_build_mode", "unified_foo", "unified_with_transition", "unified_with_transition_v2")

constraint = native.constraint
platform = native.platform

constraint(
    name = "os",
    values = [
        "linux",
        "macos",
        "windows",
    ],
    default = "linux",
)

platform(
    name = "linux_platform",
    constraint_values = [":os[linux]", ":build_mode[dev]"],
)

constraint(
    name = "cpu",
    values = [
        "x86_64",
        "arm64",
    ],
    default = "x86_64",
)

constraint(
    name = "sanitizer",
    values = [
        "asan",
        "tsan",
        "msan",
        "none",
    ],
    default = "none",
)

constraint(
    name = "build_mode",
    values = [
        "opt",
        "dev",
    ],
    default = "dev",
)

unified_foo(
    name = "foo_target",
    os = select({
        ":os[linux]": "linux",
        ":os[macos]": "macos",
        ":os[windows]": "windows",
        "DEFAULT": "default",
    }),
    cpu = select({
        ":cpu[arm64]": "arm64",
        ":cpu[x86_64]": "x86_64",
        "DEFAULT": "default",
    }),
    sanitizer_name = select({
        ":sanitizer[asan]": "ASAN",
        ":sanitizer[msan]": "MSAN",
        ":sanitizer[none]": None,
        ":sanitizer[tsan]": "TSAN",
    }),
    default_target_platform = ":linux_platform",
)

unified_build_mode(
    name = "foo_with_build_mode",
    build_mode = select({
        ":build_mode[dev]": "dev",
        ":build_mode[opt]": "opt",
    }),
    default_target_platform = ":linux_platform",
)

unified_build_mode(
    name = "bar_with_build_mode",
    build_mode = select({
        ":build_mode[dev]": "dev",
        ":build_mode[opt]": "opt",
    }),
    default_target_platform = ":linux_platform",
)

unified_with_transition(
    name = "force_opt_dep",
    build_mode = select({
        ":build_mode[dev]": "dev",
        ":build_mode[opt]": "opt",
    }),
    dep = ":foo_with_build_mode",
    opt_dep = ":bar_with_build_mode",
    default_target_platform = ":linux_platform",
)

unified_with_transition_v2(
    name = "force_opt_dep_v2",
    build_mode = select({
        ":build_mode[dev]": "dev",
        ":build_mode[opt]": "opt",
    }),
    dep = ":foo_with_build_mode",
    opt_dep = ":bar_with_build_mode",
    default_target_platform = ":linux_platform",
)
