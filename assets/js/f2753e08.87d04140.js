"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[68319],{28453:(e,i,n)=>{n.d(i,{R:()=>a,x:()=>r});var l=n(96540);const c={},s=l.createContext(c);function a(e){const i=l.useContext(s);return l.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:a(e.components),l.createElement(s.Provider,{value:i},e.children)}},57336:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"rule_authors/package_files","title":"PACKAGE Files","description":"PACKAGE files are per-directory configuration files which are accessible from","source":"@site/../docs/rule_authors/package.md","sourceDirName":"rule_authors","slug":"/rule_authors/package_files","permalink":"/docs/rule_authors/package_files","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"package_files","title":"PACKAGE Files"},"sidebar":"main","previous":{"title":"Local Resources For Tests Execution","permalink":"/docs/rule_authors/local_resources"},"next":{"title":"Dep Files","permalink":"/docs/rule_authors/dep_files"}}');var c=n(74848),s=n(28453);const a={id:"package_files",title:"PACKAGE Files"},r=void 0,d={},t=[{value:"APIs",id:"apis",level:2},{value:"<code>PACKAGE</code> APIs",id:"package-apis",level:3},{value:"<code>write_package_value</code>",id:"write_package_value",level:4},{value:"<code>read_parent_package_value</code>",id:"read_parent_package_value",level:4},{value:"<code>package</code>",id:"package",level:4},{value:"<code>read_config</code>",id:"read_config",level:4},{value:"<code>BUCK</code>-specific API",id:"buck-specific-api",level:3},{value:"<code>read_package_value</code>",id:"read_package_value",level:4}];function o(e){const i={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(i.p,{children:[(0,c.jsx)(i.code,{children:"PACKAGE"})," files are per-directory configuration files which are accessible from\nStarlark rules/macros. It supports things like per-directory properties, reading\nparent ",(0,c.jsx)(i.code,{children:"PACKAGE"})," values (",(0,c.jsx)(i.code,{children:"read_parent_package_value()"}),"), writing ",(0,c.jsx)(i.code,{children:"PACKAGE"}),"\nvalues (",(0,c.jsx)(i.code,{children:"write_package_value()"}),"), loading helper ",(0,c.jsx)(i.code,{children:"bzl"})," files, and you can also\ninspect ",(0,c.jsx)(i.code,{children:"PACKAGE"})," values via ",(0,c.jsx)(i.code,{children:"buck2 audit package-values"}),"."]}),"\n",(0,c.jsxs)(i.p,{children:["Before evaluating ",(0,c.jsx)(i.code,{children:"BUCK"})," file, buck2 will evaluate all ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files in the\nsame directory and all parent directories. Absent ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files are treated as\nempty files."]}),"\n",(0,c.jsxs)(i.p,{children:["All relevant ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files are executed sequentially from the root directory\nto the current directory (but unrelated ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files can be executed in\nparallel). Evaluating ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files sequentially provides additional\nguarantees, for example, attempt to override a property (unless explicitly\nrequested) should fail with Starlark call stack."]}),"\n",(0,c.jsxs)(i.p,{children:["Each ",(0,c.jsx)(i.code,{children:"PACKAGE"})," file is evaluated at most once (like ",(0,c.jsx)(i.code,{children:"bzl"})," files)."]}),"\n",(0,c.jsxs)(i.p,{children:[(0,c.jsx)(i.code,{children:"PACKAGE"})," files may load arbitrary ",(0,c.jsx)(i.code,{children:"bzl"})," files. ",(0,c.jsx)(i.code,{children:"BUCK"}),"-specific functions called\nin ",(0,c.jsx)(i.code,{children:"bzl"})," files (like rule functions) are available, but calling functions from\n",(0,c.jsx)(i.code,{children:"PACKAGE"})," files is an error. This way, ",(0,c.jsx)(i.code,{children:"bzl"})," files are evaluated only once\nregardless of whether they are loaded from ",(0,c.jsx)(i.code,{children:"PACKAGE"})," or ",(0,c.jsx)(i.code,{children:"BUCK"})," file."]}),"\n",(0,c.jsx)(i.h2,{id:"apis",children:"APIs"}),"\n",(0,c.jsxs)(i.h3,{id:"package-apis",children:[(0,c.jsx)(i.code,{children:"PACKAGE"})," APIs"]}),"\n",(0,c.jsx)(i.h4,{id:"write_package_value",children:(0,c.jsx)(i.a,{href:"../../api/build#write_package_value",children:(0,c.jsx)(i.code,{children:"write_package_value"})})}),"\n",(0,c.jsx)(i.pre,{children:(0,c.jsx)(i.code,{className:"language-python",children:'def write_package_value(\n    name: str,\n    value: "",\n    overwrite: bool = False,\n): ...\n'})}),"\n",(0,c.jsxs)(i.p,{children:["This global API is only available in ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files, or ",(0,c.jsx)(i.code,{children:"bzl"})," files included in\n",(0,c.jsx)(i.code,{children:"PACKAGE"})," files."]}),"\n",(0,c.jsxs)(i.p,{children:[(0,c.jsx)(i.code,{children:"name"})," is a string which must contain exactly one dot symbol (just to enforce\ncode style)."]}),"\n",(0,c.jsxs)(i.p,{children:[(0,c.jsx)(i.code,{children:"value"})," is an arbitrary Starlark value, for example, an integer, a list of\ninteger, a struct or a function. The value must be serializable into JSON."]}),"\n",(0,c.jsxs)(i.p,{children:["When ",(0,c.jsx)(i.code,{children:"overwrite"})," is ",(0,c.jsx)(i.code,{children:"False"})," (default), attempt to overwrite per-",(0,c.jsx)(i.code,{children:"PACKAGE"})," value\ndefined in parent ",(0,c.jsx)(i.code,{children:"PACKAGE"})," file will fail."]}),"\n",(0,c.jsxs)(i.p,{children:["Written values are frozen when ",(0,c.jsx)(i.code,{children:"PACKAGE"})," file evaluation is finished."]}),"\n",(0,c.jsxs)(i.p,{children:["Note ",(0,c.jsx)(i.code,{children:"write_package_value"})," symbol exists in ",(0,c.jsx)(i.code,{children:"bzl"})," globals, and it can be called\nfrom ",(0,c.jsx)(i.code,{children:"bzl"})," file in context of ",(0,c.jsx)(i.code,{children:"PACKAGE"})," evaluation, but calling\n",(0,c.jsx)(i.code,{children:"write_package_file"})," is an error on context of ",(0,c.jsx)(i.code,{children:"BUCK"})," evaluation."]}),"\n",(0,c.jsxs)(i.p,{children:["Modifying ",(0,c.jsx)(i.code,{children:"PACKAGE"})," file logically invalidates the ",(0,c.jsx)(i.code,{children:"BUCK"})," file of this\ndirectory, and all ",(0,c.jsx)(i.code,{children:"PACKAGE"})," and ",(0,c.jsx)(i.code,{children:"BUCK"})," files of sub-",(0,c.jsx)(i.code,{children:"PACKAGE"}),"s. However, ",(0,c.jsx)(i.code,{children:"BUCK"}),"\nfile evaluation may track which ",(0,c.jsx)(i.code,{children:"PACKAGE"}),"-local values were accessed and only\ninvalidate ",(0,c.jsx)(i.code,{children:"BUCK"})," files which were potentially affected (similarly to how we do\nit with buckconfigs)."]}),"\n",(0,c.jsx)(i.h4,{id:"read_parent_package_value",children:(0,c.jsx)(i.a,{href:"../../api/build#read_parent_package_value",children:(0,c.jsx)(i.code,{children:"read_parent_package_value"})})}),"\n",(0,c.jsx)(i.pre,{children:(0,c.jsx)(i.code,{className:"language-python",children:"def read_parent_package_value(\n    key: str,\n): ...\n"})}),"\n",(0,c.jsxs)(i.p,{children:["This global API is only available in ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files, or ",(0,c.jsx)(i.code,{children:"bzl"})," files included in\n",(0,c.jsx)(i.code,{children:"PACKAGE"})," files."]}),"\n",(0,c.jsxs)(i.p,{children:["This function returns the ",(0,c.jsx)(i.code,{children:"PACKAGE"})," value defined in a parent ",(0,c.jsx)(i.code,{children:"PACKAGE"})," file, or\n",(0,c.jsx)(i.code,{children:"None"})," is such value does not exist."]}),"\n",(0,c.jsxs)(i.p,{children:["This function is available in ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files, but attempt to call this function\nin context of ",(0,c.jsx)(i.code,{children:"bzl"})," file evaluation results in an error."]}),"\n",(0,c.jsx)(i.h4,{id:"package",children:(0,c.jsx)(i.a,{href:"../../api/build#package",children:(0,c.jsx)(i.code,{children:"package"})})}),"\n",(0,c.jsx)(i.pre,{children:(0,c.jsx)(i.code,{className:"language-python",children:"def package(\n    inherit: bool = False,\n    visibility: list[str] | tuple[str, ...] = [],\n    within_view: list[str] | tuple[str, ...] = []\n) -> None\n"})}),"\n",(0,c.jsxs)(i.p,{children:["This global API is only available in ",(0,c.jsx)(i.code,{children:"PACKAGE"})," files, or ",(0,c.jsx)(i.code,{children:"bzl"})," files included in\n",(0,c.jsx)(i.code,{children:"PACKAGE"})," files."]}),"\n",(0,c.jsxs)(i.p,{children:[(0,c.jsx)(i.code,{children:"visibility"})," is a list of visibility patterns to apply to all targets contained\nwithin the directory, unless the target defines it's own visibility patterns."]}),"\n",(0,c.jsxs)(i.p,{children:[(0,c.jsx)(i.code,{children:"within_view"})," is a list of visibility patterns restricting what all target\ncontained within the ",(0,c.jsx)(i.code,{children:"PACKAGE"})," directory can depend on. Applies to first-order\ndeps, and not transitive deps."]}),"\n",(0,c.jsxs)(i.p,{children:["If ",(0,c.jsx)(i.code,{children:"inherit"})," is ",(0,c.jsx)(i.code,{children:"True"}),", then the ",(0,c.jsx)(i.code,{children:"visibility"})," and ",(0,c.jsx)(i.code,{children:"within_view"})," will be\ninherited from the nearest parent ",(0,c.jsx)(i.code,{children:"PACKAGE"}),"."]}),"\n",(0,c.jsx)(i.h4,{id:"read_config",children:(0,c.jsx)(i.a,{href:"../../api/build#read_config",children:(0,c.jsx)(i.code,{children:"read_config"})})}),"\n",(0,c.jsxs)(i.p,{children:[(0,c.jsx)(i.code,{children:"PACKAGE"})," files are able to call ",(0,c.jsx)(i.code,{children:"read_config"})," to read buckconfigs."]}),"\n",(0,c.jsxs)(i.h3,{id:"buck-specific-api",children:[(0,c.jsx)(i.code,{children:"BUCK"}),"-specific API"]}),"\n",(0,c.jsx)(i.h4,{id:"read_package_value",children:(0,c.jsx)(i.a,{href:"../../api/build#read_package_value",children:(0,c.jsx)(i.code,{children:"read_package_value"})})}),"\n",(0,c.jsx)(i.pre,{children:(0,c.jsx)(i.code,{className:"language-python",children:"def read_package_value(\n    name: str,\n): ...\n"})}),"\n",(0,c.jsxs)(i.p,{children:["This global API is only available in ",(0,c.jsx)(i.code,{children:"BUCK"})," files, or ",(0,c.jsx)(i.code,{children:"bzl"})," files included in\n",(0,c.jsx)(i.code,{children:"BUCK"})," files."]}),"\n",(0,c.jsxs)(i.p,{children:["This function returns the nearest ",(0,c.jsx)(i.code,{children:"name"})," value registered per ",(0,c.jsx)(i.code,{children:"PACKAGE"}),", or\n",(0,c.jsx)(i.code,{children:"None"})," is such value does not exist."]}),"\n",(0,c.jsxs)(i.p,{children:["This function is available in ",(0,c.jsx)(i.code,{children:"bzl"})," files, but attempt to call this function in\ncontext of ",(0,c.jsx)(i.code,{children:"PACKAGE"})," file evaluation results in an error. This restriction can\nbe lifted in the future."]})]})}function h(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,c.jsx)(i,{...e,children:(0,c.jsx)(o,{...e})}):o(e)}}}]);