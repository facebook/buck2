"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[15999],{28453:(e,s,r)=>{r.d(s,{R:()=>c,x:()=>i});var n=r(96540);const o={},t=n.createContext(o);function c(e){const s=n.useContext(t);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),n.createElement(t.Provider,{value:s},e.children)}},40880:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>a,contentTitle:()=>i,default:()=>u,frontMatter:()=>c,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"rule_authors/local_resources","title":"Local Resources For Tests Execution","description":"Executing a test might require an external resource which is expensive to","source":"@site/../docs/rule_authors/local_resources.md","sourceDirName":"rule_authors","slug":"/rule_authors/local_resources","permalink":"/docs/rule_authors/local_resources","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"local_resources","title":"Local Resources For Tests Execution"},"sidebar":"main","previous":{"title":"subdir_glob()","permalink":"/docs/rule_authors/subdir_glob"},"next":{"title":"PACKAGE Files","permalink":"/docs/rule_authors/package_files"}}');var o=r(74848),t=r(28453);const c={id:"local_resources",title:"Local Resources For Tests Execution"},i=void 0,a={},l=[{value:"<code>LocalResourceInfo</code> provider",id:"localresourceinfo-provider",level:2},{value:"Test Execution",id:"test-execution",level:2},{value:"Example Usage",id:"example-usage",level:2}];function d(e){const s={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(s.p,{children:["Executing a test might require an external resource which is expensive to\ncreate. For example running an iOS UI test requires an iOS simulator and it\ntakes relatively long time to setup it prior to test execution. When tests are\nexecuted remotely resources initialization and allocation could be preemptively\nmanaged by remote execution tier which is not the case for local execution. To\neffectively manage such resources needed for local execution of tests there is a\nseparate Buck2 feature backed by ",(0,o.jsx)(s.code,{children:"LocalResourceInfo"})," provider."]}),"\n",(0,o.jsxs)(s.h2,{id:"localresourceinfo-provider",children:[(0,o.jsx)(s.code,{children:"LocalResourceInfo"})," provider"]}),"\n",(0,o.jsx)(s.p,{children:"This provider describes how to initialize and clean up a pool of homogeneous\nlocal resources. Management of initialized resources is done by Buck2 itself\nwhen it executes tests requiring such resources."}),"\n",(0,o.jsx)(s.p,{children:"Fields:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"setup"})," \u2014 command represented by ",(0,o.jsx)(s.code,{children:"cmd_args"})," object which is executed to\ninitialize a local resource. Running this command should write a JSON to\nstdout. This JSON represents a pool of local resources which are ready to be\nused."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"resource_env_vars"})," \u2014 key-value mapping ",(0,o.jsx)(s.code,{children:"{str: str}"})," from environment variable\n(appended to an execution command for test which is dependent on this local\nresource) to keys in JSON output of ",(0,o.jsx)(s.code,{children:"setup"})," command."]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Example JSON output of ",(0,o.jsx)(s.code,{children:"setup"})," command:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-json",children:'{\n  "pid": 42,\n  "resources": [{"socket_address": "foo:1"}, {"socket_address": "bar:2"}]\n}\n'})}),"\n",(0,o.jsx)(s.p,{children:"JSON keys:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"pid"})," \u2014 an optional attribute which maps to a PID of a process that holds\ninitialized local resources. If present, on non-Windows platforms the process\nwill be sent ",(0,o.jsx)(s.code,{children:"SIGTERM"})," when those resources are no longer needed. Signal\nshould be handled to release any system resources related to local resources."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"resources"})," \u2014 a list of resource instances, each is a mapping from a string\nalias (e.g. ",(0,o.jsx)(s.code,{children:"socket_address"}),") to a value which represents resource. The number\nof concurrently running tests that require resources of the same type is\nlimited by how many instances are in a list. String alias is mapped to an\nenvironment variable key (which will be added to a command requiring such\nresource) using a ",(0,o.jsx)(s.code,{children:"resource_env_vars"})," field in ",(0,o.jsx)(s.code,{children:"LocalResourceInfo"})," provider\n(see ",(0,o.jsx)(s.a,{href:"#example-usage",children:"example"})," below)."]}),"\n"]}),"\n",(0,o.jsx)(s.h2,{id:"test-execution",children:"Test Execution"}),"\n",(0,o.jsxs)(s.p,{children:["For a general context on how tests are executed, see\n",(0,o.jsx)(s.a,{href:"/docs/rule_authors/test_execution",children:"Test Execution"}),"."]}),"\n",(0,o.jsxs)(s.p,{children:["A decision whether certain local resource is required for specific test is made\nby a test runner. List of required resources is then passed to Buck2 in\n",(0,o.jsx)(s.code,{children:"required_local_resources"})," field of ",(0,o.jsx)(s.code,{children:"ExecuteRequest2"})," test API protobuf message."]}),"\n",(0,o.jsxs)(s.p,{children:["If resource is required for a certain test execution and test could potentially\nbe executed locally, ",(0,o.jsx)(s.code,{children:"local_resources"})," field in test's ",(0,o.jsx)(s.code,{children:"ExternalRunnerTestInfo"}),"\nprovider is used to select appropriate ",(0,o.jsx)(s.code,{children:"LocalResourceInfo"})," provider."]}),"\n",(0,o.jsxs)(s.p,{children:[(0,o.jsx)(s.code,{children:"ExternalRunnerTestInfo.local_resources"})," is a key-value mapping\n",(0,o.jsx)(s.code,{children:'{str: ["label", None]}'}),". Keys represent resource types that match the values\npassed from the test runner, and values are labels that should point to a target\nexposing the ",(0,o.jsx)(s.code,{children:"LocalResourceInfo"})," provider to be used for the initialization of\nthe resource of that type. If the value is ",(0,o.jsx)(s.code,{children:"None"}),", it indicates that a resource\nof that type will not be provided, even if the test runner requests it."]}),"\n",(0,o.jsxs)(s.p,{children:["Before running a test, ",(0,o.jsx)(s.code,{children:"setup"})," command from selected provider is executed and\nits output is used to create a pool of resource instances. This pool is shared\nacross all tests pointing to the same configured target label containing\n",(0,o.jsx)(s.code,{children:"LocalResourceInfo"})," provider (normally that means pool is shared for tests\nrequiring same resource type). A resource is acquired (with potential queuing)\nfrom that pool prior single test is executed and is returned back to the pool\nwhen test finished execution. After ",(0,o.jsx)(s.code,{children:"buck2 test"})," command is finished, cleanup is\nperformed when SIGTERM is sent to each process holding a pool of resources."]}),"\n",(0,o.jsx)(s.h2,{id:"example-usage",children:"Example Usage"}),"\n",(0,o.jsxs)(s.p,{children:["Define a target which has ",(0,o.jsx)(s.code,{children:"LocalResourceInfo"})," provider:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-python",children:'simulator(\n  name = "my_resource",\n  broker = ":broker",\n)\n'})}),"\n",(0,o.jsxs)(s.p,{children:["where ",(0,o.jsx)(s.code,{children:"broker"})," points to a runnable handling actual simulators."]}),"\n",(0,o.jsxs)(s.p,{children:["Implementation of ",(0,o.jsx)(s.code,{children:"simulator"})," rule would be:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-python",children:'def _impl(ctx: AnalysisContext) -> ["provider"]:\n  return [\n    DefaultInfo(),\n    LocalResourceInfo(\n      setup = cmd_args([ctx.attrs.broker[RunInfo]]),\n      resource_env_vars = { "IDB_COMPANION": "socket_address" },\n    )\n  ]\n'})}),"\n",(0,o.jsxs)(s.p,{children:["Running a ",(0,o.jsx)(s.code,{children:":broker"})," via ",(0,o.jsx)(s.code,{children:"setup"})," command produces the following JSON:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-json",children:'{\n  "pid": 42,\n  "resources": [{"socket_address": "foo:1"}, {"socket_address": "bar:2"}]\n}\n'})}),"\n",(0,o.jsxs)(s.p,{children:["When Buck2 locally executes a test which requires this particular type of local\nresource, it reserves one resource from the pool (e.g.\n",(0,o.jsx)(s.code,{children:'{"socket_address": "bar:2"}'}),") and add environment variable representing this\nresource to execution command (e.g. ",(0,o.jsx)(s.code,{children:"IDB_COMPANION=bar:2"}),"). In our examples\n",(0,o.jsx)(s.code,{children:'"socket_address"'})," alias was substituted by ",(0,o.jsx)(s.code,{children:'"IDB_COMPANION"'})," based on\n",(0,o.jsx)(s.code,{children:"LocalResourceInfo.resource_env_vars"})," field."]}),"\n",(0,o.jsxs)(s.p,{children:["The last part is to map a resource type to desired ",(0,o.jsx)(s.code,{children:"LocalResourceInfo"}),' provider.\nLet\'s assume a test runner requires a resource of type "ios_simulator" for every\n',(0,o.jsx)(s.code,{children:"apple_test"})," rule."]}),"\n",(0,o.jsxs)(s.p,{children:["Pass ",(0,o.jsx)(s.code,{children:":my_resource"})," target as a dependency into ",(0,o.jsx)(s.code,{children:"apple_test"})," rule:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-python",children:'apple_test = rule(\n    impl = apple_test_impl,\n    attrs = {\n        ...\n        "_ios_simulator": attrs.default_only(attrs.dep(default = ":my_resource", providers = [LocalResourceInfo])),\n        ...\n    },\n)\n'})}),"\n",(0,o.jsxs)(s.p,{children:['Actually map "ios_simulator" resource type to ',(0,o.jsx)(s.code,{children:":broker"})," target containing\n",(0,o.jsx)(s.code,{children:"LocalResourceInfo"})," provider:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-python",children:'def apple_test_impl(ctx: AnalysisContext) -> ["provider"]:\n    ...\n    return [\n        ...\n        ExternalRunnerTestInfo(\n            ...\n            local_resources = {\n                "ios_simulator": ctx.attrs._ios_simulator,\n            },\n            ...\n'})})]})}function u(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);