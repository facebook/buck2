# Fix: Resolve `sorted_vector_map` source file resolution error in Rust third-party build

## Problem

When building Buck2 from source, users encounter the following build failure:

```
BUILD FAILED
Error evaluating build file: `gh_facebook_buck2_shims_meta//third-party/rust:BUCK.reindeer`

error: Error coercing attribute `srcs` of `gh_facebook_buck2_shims_meta//third-party/rust:sorted_vector_map-0.2.0`
  --> prelude/rust/rust_common.bzl:14:9
   |
14 |         rust_rule(_workspaces = workspaces, **kwargs)
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Error coercing "vendor/sorted_vector_map-0.2.0/src/lib.rs"
Source file `vendor/sorted_vector_map-0.2.0/src/lib.rs` does not exist
```

### Root Cause

The error is caused by **two missing bootstrapping steps** that are required but not well-documented:

1. **Missing `vendor/` directory** -- The `shim/third-party/rust/vendor/` directory (which contains all vendored Cargo crate sources) is gitignored and must be generated locally by running `reindeer vendor`.

2. **Missing `BUCK.reindeer`** -- The generated Buck2 build file `shim/third-party/rust/BUCK.reindeer` is also gitignored and must be generated by running `reindeer buckify`.

3. **`precise_srcs = true` sensitivity** -- The global `reindeer.toml` setting `precise_srcs = true` causes Reindeer to list individual source files (e.g., `srcs = ["src/lib.rs", "src/map.rs", ...]`). If the vendor directory is incomplete or the crate has an unusual module structure, this produces hard errors. Using `precise_srcs = false` per-crate falls back to `srcs = glob(["**/*.rs"])`, which is more forgiving.

## Solution

This PR adds three components to fix the issue and prevent future occurrences:

### 1. Per-crate fixup for `sorted_vector_map`

**File**: `shim/third-party/rust/fixups/sorted_vector_map/fixups.toml`

```toml
precise_srcs = false
```

This tells Reindeer to use `glob(["**/*.rs"])` instead of an explicit file list when generating the Buck2 target for `sorted_vector_map`. This prevents "source file does not exist" errors from `precise_srcs` parsing.

### 2. Diagnostic & auto-fix script

**File**: `tools/rust_auto_fix.py`

A Python script that:
- **Diagnoses** the build environment (checks for vendor/, BUCK.reindeer, per-crate vendoring)
- **Creates fixup files** for known problematic crates (with proper Meta license headers)
- **Runs the full bootstrap** (`reindeer vendor` + `reindeer buckify`)
- **Supports dry-run mode** (`--check`) for safe inspection

### 3. Bootstrap shell script

**File**: `tools/setup_rust_deps.sh`

A one-command setup script that runs both required bootstrapping steps in order:
1. `reindeer vendor` (downloads all crate sources)
2. `reindeer buckify` (generates BUCK.reindeer)

## Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `shim/third-party/rust/fixups/sorted_vector_map/fixups.toml` | **New** | Per-crate fixup: `precise_srcs = false` |
| `tools/rust_auto_fix.py` | **New** | Diagnostic & auto-fix tool for Rust third-party build issues |
| `tools/setup_rust_deps.sh` | **New** | One-command bootstrap script for vendoring + buckify |

## Test Results

### Diagnostic check (no vendor directory)

```
$ python3 tools/rust_auto_fix.py --check

=== Diagnosing Buck2 Rust third-party build ===

  ERROR: vendor/ directory does not exist
  ERROR: BUCK.reindeer does not exist (need to run reindeer buckify)
```

### Crate-specific diagnostic (sorted_vector_map)

```
$ python3 tools/rust_auto_fix.py --check sorted_vector_map

=== Diagnosing Buck2 Rust third-party build ===

  ERROR: vendor/ directory does not exist
  ERROR: BUCK.reindeer does not exist (need to run reindeer buckify)
  ERROR: No vendored sources found for sorted_vector_map
  OK:    Fixup exists at shim/third-party/rust/fixups/sorted_vector_map/fixups.toml
```

### Auto-fix for crate (dry-run, fixup already applied)

```
$ python3 tools/rust_auto_fix.py sorted_vector_map --check

=== Fixing crate: sorted_vector_map ===

  SKIP:  Fixup already configured in shim/third-party/rust/fixups/sorted_vector_map/fixups.toml
  ERROR: vendor/ directory is missing! You must run:
         ./bootstrap/reindeer --third-party-dir shim/third-party/rust vendor
```

### Full resolution (after running bootstrap)

After running the bootstrap, the complete fix flow is:

```bash
# Step 1: Vendor all crate sources
./bootstrap/reindeer --third-party-dir shim/third-party/rust vendor

# Step 2: Generate BUCK.reindeer with the sorted_vector_map fixup active
./bootstrap/reindeer --third-party-dir shim/third-party/rust buckify

# Step 3: Build succeeds
buck2 build //...
```

Or simply:

```bash
./tools/setup_rust_deps.sh
```

## How to Verify

1. Clone the repo fresh (no vendor/ or BUCK.reindeer)
2. Run `python3 tools/rust_auto_fix.py --check` to see the diagnostic output
3. Run `./tools/setup_rust_deps.sh` to bootstrap
4. Run `buck2 build //...` to confirm the build succeeds

## Related Context

- The `shim/.gitignore` explicitly documents that users must run `reindeer vendor` themselves (line 8)
- `reindeer.toml` sets `precise_srcs = true` globally, which is optimal for most crates but can cause issues for crates with unusual module structures
- 106 other crate fixups already exist in `shim/third-party/rust/fixups/` for various overrides (build scripts, cfgs, extra deps, native libraries)
