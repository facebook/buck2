"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[83648],{20799:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"rule_authors/string_parameter_macros","title":"String parameter macros","description":"Many rule attributes (the ones with type attrs.arg) support expanding","source":"@site/../docs/rule_authors/string_parameter_macros.md","sourceDirName":"rule_authors","slug":"/rule_authors/string_parameter_macros","permalink":"/docs/rule_authors/string_parameter_macros","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"string_parameter_macros","title":"String parameter macros"},"sidebar":"main","previous":{"title":"Dep Files","permalink":"/docs/rule_authors/dep_files"},"next":{"title":"Why BXL","permalink":"/docs/bxl/"}}');var r=n(74848),s=n(28453);const o={id:"string_parameter_macros",title:"String parameter macros"},i="String parameter macros",c={},l=[{value:"<code>$(location //path/to:target)</code>",id:"location-pathtotarget",level:2},{value:"<code>$(location_exec //path/to:target)</code>",id:"location_exec-pathtotarget",level:2},{value:"<code>$(source relative/path/to/source)</code>",id:"source-relativepathtosource",level:2},{value:"<code>$(exe //path/to:target)</code>",id:"exe-pathtotarget",level:2},{value:"<code>$(exe_target //path/to:target)</code>",id:"exe_target-pathtotarget",level:2},{value:"<code>$(query_targets queryfunction(//path/to:target))</code>",id:"query_targets-queryfunctionpathtotarget",level:2},{value:"<code>$(query_outputs queryfunction(//path/to:target))</code>",id:"query_outputs-queryfunctionpathtotarget",level:2},{value:"<code>$(query_targets_and_outputs [separator] queryfunction(//path/to:target))</code>",id:"query_targets_and_outputs-separator-queryfunctionpathtotarget",level:2},{value:"<code>$(classpath //path/to:target)</code>",id:"classpath-pathtotarget",level:2},{value:"<code>$(location //path/to:target[output])</code>",id:"location-pathtotargetoutput",level:2},{value:"How to manage long expanded values",id:"how-to-manage-long-expanded-values",level:2},{value:"How to prevent expansion",id:"how-to-prevent-expansion",level:2},{value:"Query functions",id:"query-functions",level:2},{value:"Frequently Asked Questions (FAQ)",id:"frequently-asked-questions-faq",level:2},{value:"Extended Backus-Naur form",id:"extended-backus-naur-form",level:2}];function h(e){const t={code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"string-parameter-macros",children:"String parameter macros"})}),"\n",(0,r.jsxs)(t.p,{children:["Many rule attributes (the ones with type ",(0,r.jsx)(t.code,{children:"attrs.arg"}),") support expanding\nreferences to other rules using a mechanism called string parameter macros. All\nexpanded build rules are automatically added as dependencies."]}),"\n",(0,r.jsxs)(t.p,{children:["Note that the paths returned by these macros are ",(0,r.jsx)(t.em,{children:"relative"})," paths. Using\nrelative paths ensures that your builds are ",(0,r.jsx)(t.em,{children:"hermetic"}),", that is, they are\nreproducible across different machine environments."]}),"\n",(0,r.jsx)(t.h2,{id:"location-pathtotarget",children:(0,r.jsx)(t.code,{children:"$(location //path/to:target)"})}),"\n",(0,r.jsx)(t.p,{children:"Expands to the location of the output of the specified build rule. This means\nthat you can refer to the output without needing to be aware of how Buck is\nstoring data on the disk mid-build."}),"\n",(0,r.jsx)(t.p,{children:"For example:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'cxx_test(\n    name = "my_test",\n    srcs = ["main.cpp"],\n    preprocessor_flags = ["-DTEST_DIR=$(location :test_dir)"],\n)\n\nfilegroup(\n    name = "test_dir",\n    srcs = [\n        "test_files/foo.json",\n        "test_files/bar.toml",\n    ],\n)\n'})}),"\n",(0,r.jsx)(t.h2,{id:"location_exec-pathtotarget",children:(0,r.jsx)(t.code,{children:"$(location_exec //path/to:target)"})}),"\n",(0,r.jsxs)(t.p,{children:["Identical to ",(0,r.jsx)(t.code,{children:"$(location //path/to:target)"}),", but the configuration is\ntransitioned to the execution platform. This can be useful when using ",(0,r.jsx)(t.code,{children:"genrule"}),"\nto wrap another build system with buck."]}),"\n",(0,r.jsx)(t.h2,{id:"source-relativepathtosource",children:(0,r.jsx)(t.code,{children:"$(source relative/path/to/source)"})}),"\n",(0,r.jsxs)(t.p,{children:["Expands to the location of the specified source. The difference with using\n",(0,r.jsx)(t.code,{children:"$(location path/to:export_file_target)"})," is that the path points to the file in\nthe source tree, rather than a copy or symlink in ",(0,r.jsx)(t.code,{children:"buck-out"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"For example:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'cxx_test(\n    name = "my_test",\n    srcs = ["main.cpp"],\n    preprocessor_flags = ["-DMY_SOURCE_FILE=$(source path/to/my_source_file)"],\n)\n'})}),"\n",(0,r.jsx)(t.h2,{id:"exe-pathtotarget",children:(0,r.jsx)(t.code,{children:"$(exe //path/to:target)"})}),"\n",(0,r.jsx)(t.p,{children:"Expands a build rule that results in an executable to the commands necessary to\nrun that executable as part of the build."}),"\n",(0,r.jsxs)(t.p,{children:["For example, a ",(0,r.jsx)(t.code,{children:"java_binary()"})," might expand to a call to\n",(0,r.jsx)(t.code,{children:"java -jar path/to/target.jar"}),". Files that are executable (perhaps generated by\na ",(0,r.jsx)(t.code,{children:"genrule()"}),") are also expanded."]}),"\n",(0,r.jsx)(t.p,{children:"If the build rule does not generate an executable output, then an exception is\nthrown and the build breaks."}),"\n",(0,r.jsxs)(t.p,{children:["If the ",(0,r.jsx)(t.code,{children:"$(exe my_dependency)"})," dependency should actually be built with the\ntarget platform, use ",(0,r.jsx)(t.code,{children:"$(exe_target my_dependency)"})," instead, which will stick to\nthe same platform as the target."]}),"\n",(0,r.jsx)(t.h2,{id:"exe_target-pathtotarget",children:(0,r.jsx)(t.code,{children:"$(exe_target //path/to:target)"})}),"\n",(0,r.jsxs)(t.p,{children:["Identical to ",(0,r.jsx)(t.code,{children:"$(exe //path/to:target)"}),", except that the target is built using\nthe target platform, rather than the execution platform."]}),"\n",(0,r.jsx)(t.p,{children:"This is for example useful to get the paths to executables to be run as part of\ntests. For example:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'sh_test(\n    name = "my_test",\n    args = [\n        "$(exe_target //path/to:target_to_test)",\n    ],\n    # `my_test.sh` takes a single argument, which is the path to an executable\n    # to test.\n    test = "my_test.sh",\n    visibility = ["//risk/tap_enricher/..."],\n)\n'})}),"\n",(0,r.jsx)(t.h2,{id:"query_targets-queryfunctionpathtotarget",children:(0,r.jsx)(t.code,{children:"$(query_targets queryfunction(//path/to:target))"})}),"\n",(0,r.jsx)(t.p,{children:"Runs a query on the given target and replaces the macro with the matching\ntargets."}),"\n",(0,r.jsx)(t.p,{children:"For example:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'my_rule(\n    name = "example",\n    # Will be replaced by all dependencies of `some_target`.\n    foo = "$(query_targets deps(:some_target))"\n)\n'})}),"\n",(0,r.jsx)(t.h2,{id:"query_outputs-queryfunctionpathtotarget",children:(0,r.jsx)(t.code,{children:"$(query_outputs queryfunction(//path/to:target))"})}),"\n",(0,r.jsx)(t.p,{children:"Runs a query on the given target and replaces the macro with the outputs of the\nmatching targets."}),"\n",(0,r.jsx)(t.p,{children:"For example:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'my_rule(\n    name = "example",\n    # Will be replaced by the outputs of all dependencies of `some_target`.\n    foo = "$(query_outputs deps(:some_target))"\n)\n'})}),"\n",(0,r.jsx)(t.h2,{id:"query_targets_and_outputs-separator-queryfunctionpathtotarget",children:(0,r.jsx)(t.code,{children:"$(query_targets_and_outputs [separator] queryfunction(//path/to:target))"})}),"\n",(0,r.jsxs)(t.p,{children:["Runs a query on the given target and replaces the macro with matching targets\nand their outputs, which are separated by an optional ",(0,r.jsx)(t.code,{children:"separator"})," (defaults to a\nspace)."]}),"\n",(0,r.jsx)(t.p,{children:"For example:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'my_rule(\n    name = "example",\n    # Will be replaced by the space-separated dependencies of `some_target`, as\n    # well as their outputs.\n    foo = "$(query_targets_and_outputs deps(:some_target))"\n)\n'})}),"\n",(0,r.jsx)(t.h2,{id:"classpath-pathtotarget",children:(0,r.jsx)(t.code,{children:"$(classpath //path/to:target)"})}),"\n",(0,r.jsxs)(t.p,{children:["Expands to the transitive classpath of the specified build rule, provided that\nthe rule has a Java classpath. If the rule does not have (or contribute to) a\nclasspath, then an exception is thrown and the build breaks. It takes an\noptional second argument to limit the depth of the traversal, but only a depth\nof 1 is currently supported. Its behavior is similar to the corresponding\noperation in the ",(0,r.jsx)(t.code,{children:"buck audit"})," command."]}),"\n",(0,r.jsx)(t.h2,{id:"location-pathtotargetoutput",children:(0,r.jsx)(t.code,{children:"$(location //path/to:target[output])"})}),"\n",(0,r.jsx)(t.p,{children:"Expands to the named output file or directory of the given target, for rules\nthat expose supplementary outputs."}),"\n",(0,r.jsx)(t.h2,{id:"how-to-manage-long-expanded-values",children:"How to manage long expanded values"}),"\n",(0,r.jsx)(t.p,{children:"In some cases, the results of the expanded macro might be so long that they\nexceed a limit in your operating environment. For example, if you use the\nresults of an expanded macro in Bash, it could exceed Bash's command-line\nlimits."}),"\n",(0,r.jsxs)(t.p,{children:["To work around these limits, prefix the macro name with the ",(0,r.jsx)(t.code,{children:"@"})," character. Buck\nthen writes the results of the expanded macro to a temporary file and replaces\nthe macro with the path to that file ",(0,r.jsxs)(t.em,{children:["while keeping the ",(0,r.jsx)(t.code,{children:"@"})," prefix"]}),". For\nexample:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"$(@query_targets_and_outputs //...)\n"})}),"\n",(0,r.jsx)(t.p,{children:"expands to something similar to:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"@/tmp/tempfile\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Many applications recognize the ",(0,r.jsx)(t.code,{children:"@"})," prefix to mean: ",(0,r.jsx)(t.em,{children:"read the contents of this\nfile to obtain the necessary arguments"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"how-to-prevent-expansion",children:"How to prevent expansion"}),"\n",(0,r.jsx)(t.p,{children:"If you need to prevent expansion of a string parameter macro, prefix the macro\nwith a backslash."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"\\$(dirname ...)\n"})}),"\n",(0,r.jsxs)(t.p,{children:["For example, the following rule passes the ",(0,r.jsx)(t.code,{children:"dirname"})," command to the shell to\nexecute in a subshell; ",(0,r.jsx)(t.code,{children:"dirname"})," is a Unix/Linux command-line utility that\nreturns the directory of a specified file. We need to use an escape because the\nsyntax for subshells is the same as the syntax for string parameter macros:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:"genrule(\n  name = 'gen',\n  out  = 'out.txt',\n  cmd  = 'cp $SRCS \\$(dirname $OUT)',\n  srcs = [\n    'test1.txt',\n    'test2.txt',\n  ],\n)\n"})}),"\n",(0,r.jsx)(t.h2,{id:"query-functions",children:"Query functions"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"query_*"})," macros accept a quoted query expression which supports the\nfollowing query functions:"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"attrfilter"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"attrregexfilter"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"deps"})}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"except"})," (set-difference)"]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"filter"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"intersect"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"kind"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"rdeps"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"set"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"union"})}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"frequently-asked-questions-faq",children:"Frequently Asked Questions (FAQ)"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"When are macros evaluated?"})," Macros are evaluated before the command is\npassed to the shell for execution. You can think of them as simple string\nreplacements."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Can macros be nested?"})," Macros cannot be nested. If you need to run an\nadditional macro on the output of a previous macro, create a nested ",(0,r.jsx)(t.code,{children:"genrule"}),"\ndefinition and use the ",(0,r.jsx)(t.code,{children:"$(location)"})," macro to read the output of the previous\nmacro."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Are parentheses okay inside a macro?"})," Inside a macro, parentheses must be\nbalanced. Parentheses which are part of a quoted string are ignored."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Is white space okay inside a macro?"})," Macro arguments are white space\nseparated, so arguments which contain white space must be quoted."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Are nested quotes allowed?"})," A single level of nested quotes is allowed,\nsuch as ",(0,r.jsx)(t.code,{children:"\"My name is 'Buck'.\""})," or ",(0,r.jsx)(t.code,{children:"'My name is \"Buck\".'"}),". Note that when you\nuse a macro in a BUCK file, you must ensure that quotes are properly escaped,\nso that the shell command that uses the macro forms a proper string."]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"extended-backus-naur-form",children:"Extended Backus-Naur form"}),"\n",(0,r.jsx)(t.p,{children:"The Extended Backus-Naur form (EBNF) grammar for a macro is as follows:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'macro = "$(", macro_name, whitespace, [arg_list], ")";\nmacro_name = {all_ascii_chars - whitespace - parens};\nwhitespace = "\\t" | "\\n" | " " | "\\r";\nparens = "(" | ")";\narg_list = arg | arg, whitespace, arg_list;\narg = {all_ascii_chars - whitespace - parens}\n      | "(", arg, ")"\n      | "\\"", [{-"\\""}], "\\""\n      | "\'", [{-"\'"}], "\'";\n'})})]})}function d(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>i});var a=n(96540);const r={},s=a.createContext(r);function o(e){const t=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),a.createElement(s.Provider,{value:t},e.children)}}}]);