"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[75152],{28453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>r});var i=t(96540);const o={},s=i.createContext(o);function l(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),i.createElement(s.Provider,{value:n},e.children)}},34826:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"bxl/how_tos/how_to_collect_telemetry_events","title":"How to Collect Telemetry Events","description":"Telemetry","source":"@site/../docs/bxl/how_tos/how_to_collect_telemetry_events.md","sourceDirName":"bxl/how_tos","slug":"/bxl/how_tos/how_to_collect_telemetry_events","permalink":"/docs/bxl/how_tos/how_to_collect_telemetry_events","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"how_to_collect_telemetry_events","title":"How to Collect Telemetry Events"},"sidebar":"main","previous":{"title":"How to Use Target Universe in BXL","permalink":"/docs/bxl/how_tos/how_to_use_target_universe"},"next":{"title":"BXL Basics","permalink":"/docs/bxl/explanation/basics"}}');var o=t(74848),s=t(28453);const l={id:"how_to_collect_telemetry_events",title:"How to Collect Telemetry Events"},r=void 0,a={},c=[{value:"Telemetry",id:"telemetry",level:2},{value:"Emitting events from your BXL script",id:"emitting-events-from-your-bxl-script",level:3},{value:"User event log",id:"user-event-log",level:3},{value:"Getting a user event log from a normal event log",id:"getting-a-user-event-log-from-a-normal-event-log",level:3},{value:"Event log output",id:"event-log-output",level:3}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"telemetry",children:"Telemetry"}),"\n",(0,o.jsx)(n.h3,{id:"emitting-events-from-your-bxl-script",children:"Emitting events from your BXL script"}),"\n",(0,o.jsxs)(n.p,{children:["In BXL, you can emit custom events via ",(0,o.jsx)(n.code,{children:"ctx.instant_event()"}),", which takes in two\nnamed parameters:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"id"}),": string, identifies your event. Helpful to identify your event when\nlooking through event logs. Ids do not have to be unique in a single BXL\nscript."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"metadata"}),": dict, where keys are strings, and values are strings, bools, ints,\nor lists/dicts of the mentioned types. You can put any metadata you wish here."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Example:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def _impl(ctx):\n  ctx.instant_event(id = "id1", metadata = {"foo": "bar"})\n\nmy_script = bxl_main(\n  impl = _impl,\n  cli_args = {},\n)\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Only instant events can be manually created within BXL at this time, which means\nthat the event represents a single point in time. If you need something similar\nto spans (start and end events which encompass a range of time) for measuring\nthe duration of a particular section (excluding actions - see below for more\ninformation), you could couple instant events with the global ",(0,o.jsx)(n.code,{children:"now()"})," function\nto measure the duration yourself:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def _impl(ctx):\n  instant = now()\n\n  # do something time intensive\n  end = instant.elapsed_millis()\n  ctx.instant_event(id = "id1", metadata = {"duration": end})\n\n  # do something else time intensive\n  end = instant.elapsed_millis()\n  ctx.instant_event(id = "id2", metadata = {"duration": end})\n\nmy_script = bxl_main(\n  impl = _impl,\n  cli_args = {},\n)\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Measuring time for actions and ensuring artifacts"})}),"\n",(0,o.jsxs)(n.p,{children:["You cannot use ",(0,o.jsx)(n.code,{children:"now()"})," to measure the time it takes to run actions and ensure\nartifacts because these processes occur asynchronously outside of the BXL script\nexecution. For BXL user telemetry, we emit action events via the buck2 core\nautomatically. Events around ensuring the artifacts are not emitted currently,\nbut will be added soon."]}),"\n",(0,o.jsx)(n.h3,{id:"user-event-log",children:"User event log"}),"\n",(0,o.jsxs)(n.p,{children:["To write to your own event log when running BXL, you can run your BXL command\nwith the ",(0,o.jsx)(n.code,{children:"--user-event-log"})," flag to tell buck2 where to write the events to.\nBuck2 is aware of the following file extensions: ",(0,o.jsx)(n.code,{children:".json-lines"}),",\n",(0,o.jsx)(n.code,{children:"json-lines.zst"}),", ",(0,o.jsx)(n.code,{children:".json-lines.gz"}),", and will compress the files automatically\nfor you depending on the extension. If the extension is not one of these, the\nlogs will always be written in JSONL format, uncompressed."]}),"\n",(0,o.jsx)(n.p,{children:"Example:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"buck2 bxl path//to/my_script/script.bxl:my_script --user-event-log my_file.json-lines.gz\n"})}),"\n",(0,o.jsxs)(n.p,{children:["When using this flag to write to a custom event log, it is up to you to clean up\nthese log files. In addition, if the same filename is used with subsequent BXL\ninvocations, events are always appended to the existing file contents, which is\nthe same behavior as ",(0,o.jsx)(n.code,{children:"buck2 <any command> --event-log <path>"}),". If you tell buck2\nto write to a compressed file, you are responsible for decompressing them."]}),"\n",(0,o.jsx)(n.h3,{id:"getting-a-user-event-log-from-a-normal-event-log",children:"Getting a user event log from a normal event log"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"buck2 log show-user"})," can be used to convert a normal event log (regardless of\nencoding/compression) to a user event. Similar to ",(0,o.jsx)(n.code,{children:"buck2 log show"}),", you can\nchoose the most recent invocation, or the nth invocation, or provide a path to\nthe normal user event log. Note that user event logs are not able to be passed\ninto ",(0,o.jsx)(n.code,{children:"buck2 log show"})," or ",(0,o.jsx)(n.code,{children:"buck2 log show-user"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"event-log-output",children:"Event log output"}),"\n",(0,o.jsx)(n.p,{children:"The first line of your event log will always be the invocation record, which\ncontains useful things like command line args used, working directory, etc. The\nsubsequent lines are either instant events and/or action events, depending on\nyour BXL script's contents."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Instant event"})}),"\n",(0,o.jsx)(n.p,{children:"Sample:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'{\n  "StarlarkUserEvent": {\n    "id": "foo",\n    "metadata": {\n      "bool_value": true,\n      "string_value": "str",\n      "int_value": 123,\n      "list_value": [\n        "a",\n        "b",\n        "c"\n      ],\n      "dict_value": {\n        "foo": "bar"\n      }\n    },\n  },\n  "epoch_millis": 123456789 # when the event was emitted\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Action event"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'{\n  "ActionExecutionEvent": {\n    "kind": "Write", # kind of action, like write or run\n    "name": { # name of the action, for user display. Unique within the execution of a particular target\n      "category": "write", # category for the action\n      "identifier": "my_output" # identifier for the action\n    },\n    "duration_millis": 0, # duration of the action in millis, excluding input materialization time\n    "output_size": 10, # size in bytes of the action\'s outputs\n    "input_materialization_duration_millis": 0, # how long it took to materialize any inputs to the action\n    "execution_kind": "Simple", # how the action was executed\n    "owner": "cell//path/to/script.bxl:function_name" # owner of the action execution (target label, anon target label, bxl label)\n  },\n  "epoch_millis": 123456789 # when the event was emitted\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"execution_kind"})," includes:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Local: action was executed locally"}),"\n",(0,o.jsx)(n.li,{children:"Remote: action was executed via a remote executor"}),"\n",(0,o.jsx)(n.li,{children:"ActionCache: action was served by the action cache and not executed"}),"\n",(0,o.jsx)(n.li,{children:"Simple: action is simple and executed inline within buck2 (ex: write,\nsymlink_dir)"}),"\n",(0,o.jsx)(n.li,{children:"Skipped: action was not executed at all"}),"\n",(0,o.jsx)(n.li,{children:"Deferred: action logically executed, but didn't do all the work"}),"\n",(0,o.jsx)(n.li,{children:"LocalDepFile: action was served by the local dep file cache and not executed."}),"\n",(0,o.jsx)(n.li,{children:"LocalWorker: action was executed via a local worker"}),"\n",(0,o.jsx)(n.li,{children:"NotSet: action execution kind was not set"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Ensure artifact event"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'{\n  "BxlEnsureArtifactsEvent": {\n    "duration_millis": 0, # duration of ensuring the artifact\n  },\n  "epoch_millis": 123456789 # when the event was emitted\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);