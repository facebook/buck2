"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[16319],{5324:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"concepts/buck_query_language","title":"Buck Query Language","description":"Buck2\'s query language provides a powerful way to inspect and analyze the build","source":"@site/../docs/concepts/buck_query_language.md","sourceDirName":"concepts","slug":"/concepts/buck_query_language","permalink":"/docs/concepts/buck_query_language","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"buck_query_language","title":"Buck Query Language"},"sidebar":"main","previous":{"title":"Target Pattern","permalink":"/docs/concepts/target_pattern"},"next":{"title":"buck-out","permalink":"/docs/concepts/buck_out"}}');var t=r(74848),o=r(28453);const i={id:"buck_query_language",title:"Buck Query Language"},a="Buck Query Language",c={},l=[{value:"Query Parameters",id:"query-parameters",level:2},{value:"Non-target Parameters",id:"non-target-parameters",level:3},{value:"Quoting Arguments",id:"quoting-arguments",level:2},{value:"Algebraic Set Operations",id:"algebraic-set-operations",level:2},{value:"Set Operations: intersection, union, set difference",id:"set-operations-intersection-union-set-difference",level:3},{value:"Group Targets: set()",id:"group-targets-set",level:3},{value:"Executing Multiple Queries at Once",id:"executing-multiple-queries-at-once",level:2},{value:"Referencing Args Files",id:"referencing-args-files",level:2},{value:"Query Environments",id:"query-environments",level:2},{value:"See Also",id:"see-also",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"buck-query-language",children:"Buck Query Language"})}),"\n",(0,t.jsxs)(n.p,{children:["Buck2's query language provides a powerful way to inspect and analyze the build\ngraph. The query language is shared across different query commands\n(",(0,t.jsx)(n.code,{children:"buck2 uquery"}),", ",(0,t.jsx)(n.code,{children:"buck2 cquery"}),", and ",(0,t.jsx)(n.code,{children:"buck2 aquery"}),"), though each command\noperates on different graph representations and supports different sets of\noperators."]}),"\n",(0,t.jsx)(n.h2,{id:"query-parameters",children:"Query Parameters"}),"\n",(0,t.jsx)(n.p,{children:"The most common parameter for a Buck query operator is an expression that\nevaluates to a build target or collection of build targets. Such an expression\ncould be:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["An explicit ",(0,t.jsx)(n.a,{href:"/docs/concepts/build_target",children:"build target"})]}),"\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.a,{href:"/docs/concepts/target_pattern",children:"build target pattern"})]}),"\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.a,{href:"/docs/concepts/buckconfig",children:".buckconfig alias"})]}),"\n",(0,t.jsx)(n.li,{children:"The set of targets returned by another Buck query operator"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Tip:"})," You can pass an alias directly to the ",(0,t.jsx)(n.code,{children:"buck2 query"})," command line to see\nwhat it resolves to. For example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"buck2 uquery app\n"})}),"\n",(0,t.jsx)(n.h3,{id:"non-target-parameters",children:"Non-target Parameters"}),"\n",(0,t.jsxs)(n.p,{children:["In addition to target parameters, some Buck query operators take string\nparameters such as filenames (",(0,t.jsx)(n.code,{children:"owner()"}),") or regular expressions (",(0,t.jsx)(n.code,{children:"filter()"}),")."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note:"})," Hover over parameters in query operator syntax to see their\ndescriptions in the command documentation."]}),"\n",(0,t.jsx)(n.h2,{id:"quoting-arguments",children:"Quoting Arguments"}),"\n",(0,t.jsxs)(n.p,{children:["It is not necessary to quote arguments if they comprise sequences of characters\ndrawn from the alphabet, numerals, forward slash (",(0,t.jsx)(n.code,{children:"/"}),"), colon (",(0,t.jsx)(n.code,{children:":"}),"), period\n(",(0,t.jsx)(n.code,{children:"."}),"), hyphen (",(0,t.jsx)(n.code,{children:"-"}),"), underscore (",(0,t.jsx)(n.code,{children:"_"}),"), or asterisk (",(0,t.jsx)(n.code,{children:"*"}),")\u2014and they do not start\nwith a hyphen or period. For example, quoting ",(0,t.jsx)(n.code,{children:"java_test"})," is unnecessary."]}),"\n",(0,t.jsxs)(n.p,{children:["However, we ",(0,t.jsx)(n.strong,{children:"do recommend"})," that you quote arguments as a best practice even\nwhen Buck2 doesn't require it."]}),"\n",(0,t.jsxs)(n.p,{children:["You should always use quotes when writing scripts that construct ",(0,t.jsx)(n.code,{children:"buck2 query"}),"\nexpressions from user-supplied values."]}),"\n",(0,t.jsxs)(n.p,{children:["Note that argument quoting for ",(0,t.jsx)(n.code,{children:"buck2 query"})," is in addition to any quoting that\nyour shell requires. In the following example, double-quotes are used for the\nshell and single-quotes are used for the build target expression:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"buck2 uquery \"'//foo:bar=wiz'\"\n"})}),"\n",(0,t.jsx)(n.h2,{id:"algebraic-set-operations",children:"Algebraic Set Operations"}),"\n",(0,t.jsx)(n.p,{children:"Buck2's query language supports algebraic set operations for combining query\nresults."}),"\n",(0,t.jsx)(n.h3,{id:"set-operations-intersection-union-set-difference",children:"Set Operations: intersection, union, set difference"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Nominal"}),(0,t.jsx)(n.th,{children:"Symbolic"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"intersect"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"^"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"union"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"+"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"except"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"-"})})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["These three operators compute the corresponding set operations over their\narguments. Each operator has two forms: a nominal form (e.g., ",(0,t.jsx)(n.code,{children:"intersect"}),") and a\nsymbolic form (e.g., ",(0,t.jsx)(n.code,{children:"^"}),"). The two forms are equivalent; the symbolic forms are\njust faster to type."]}),"\n",(0,t.jsx)(n.p,{children:"For example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"buck2 uquery \"deps('//foo:bar') intersect deps('//baz:lib')\"\n"})}),"\n",(0,t.jsx)(n.p,{children:"and"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"buck2 uquery \"deps('//foo:bar') ^ deps('//baz:lib')\"\n"})}),"\n",(0,t.jsxs)(n.p,{children:["both return the targets that appear in the transitive closure of ",(0,t.jsx)(n.code,{children:"//foo:bar"})," and\n",(0,t.jsx)(n.code,{children:"//baz:lib"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Properties:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"intersect"})," (",(0,t.jsx)(n.code,{children:"^"}),") and ",(0,t.jsx)(n.code,{children:"union"})," (",(0,t.jsx)(n.code,{children:"+"}),") operators are commutative"]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"except"})," (",(0,t.jsx)(n.code,{children:"-"}),") operator is not commutative"]}),"\n",(0,t.jsx)(n.li,{children:"The parser treats all three operators as left-associative and of equal\nprecedence"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"We recommend that you use parentheses if you need to ensure a specific order of\nevaluation. A parenthesized expression resolves to the value of the expression\nit encloses. For example, the first two expressions are equivalent, but the\nthird is not:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"x intersect y union z\n(x intersect y) union z\nx intersect (y union z)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"group-targets-set",children:"Group Targets: set()"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Syntax:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"set(<expr_a> <expr_b> <expr_c> ...)\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"set()"})," operator computes the union of a set of zero or more target\nexpressions. Separate the targets with white space (not commas). Quote the\ntargets to ensure they are parsed correctly."]}),"\n",(0,t.jsxs)(n.p,{children:["If you want to invoke ",(0,t.jsx)(n.code,{children:"buck2 query"})," on a list of targets, then ",(0,t.jsx)(n.code,{children:"set()"})," is a way\nto group this list in a query."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsxs)(n.p,{children:["The following command line returns the target ",(0,t.jsx)(n.code,{children:"main"})," in the build file in the\nroot of the Buck2 project and all the targets from the build file in the\n",(0,t.jsx)(n.code,{children:"myclass"})," subdirectory of the root:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"buck2 uquery \"set( '//:main' '//myclass:' )\"\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsxs)(n.p,{children:["The following command line returns the merged set (union) of dependencies for\nthe targets ",(0,t.jsx)(n.code,{children:"main"})," and ",(0,t.jsx)(n.code,{children:"subs"})," in the build file in the root of the Buck2\nproject:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"buck2 uquery \"deps( set( '//:main' '//:subs' ) )\"\n"})}),"\n",(0,t.jsx)(n.h2,{id:"executing-multiple-queries-at-once",children:"Executing Multiple Queries at Once"}),"\n",(0,t.jsx)(n.p,{children:"Suppose you want to know the tests associated with a set of targets. This can be\ndone by combining query operators. For example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"buck2 cquery \"testsof(deps(set('target1' 'target2' 'target3')))\"\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Suppose you now want to know the tests for ",(0,t.jsx)(n.strong,{children:"each"})," of these targets; the above\ncommand returns the union of the tests. Instead of executing one query for the\nentire set of targets, Buck2's query commands provide a way to repeat a query\nwith different targets using a single command. To do this, first define the\nquery expression format and then list the input targets, separated by spaces.\nFor example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'buck2 cquery "testsof(deps( %s ))" target1 target2 target3\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"%s"})," in the query expression is replaced by each of the listed targets, and\nfor each target, the resulting query expression is evaluated. If you add the\n",(0,t.jsx)(n.code,{children:"--output-format json"})," parameter, the result of the command is grouped by input\ntarget; otherwise, as in the previous example using ",(0,t.jsx)(n.code,{children:"set()"}),", the command merges\nthe results and returns the union of the queries."]}),"\n",(0,t.jsxs)(n.p,{children:["This syntax is also useful for subcommands that take arguments that are not\ntargets, such as ",(0,t.jsx)(n.code,{children:"owner()"}),". Recall that the ",(0,t.jsx)(n.code,{children:"set()"})," operator works only with\ntargets, but the ",(0,t.jsx)(n.code,{children:"owner()"})," operator takes a filename as its argument:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'buck2 uquery "owner( %s )" main.cpp myclass.cpp myclass.h\n'})}),"\n",(0,t.jsx)(n.h2,{id:"referencing-args-files",children:"Referencing Args Files"}),"\n",(0,t.jsxs)(n.p,{children:["When running queries, arguments can be stored in external files, one argument\nper line, and referenced with the ",(0,t.jsx)(n.code,{children:"@"})," symbol. This is convenient when the number\nof arguments is long or when you want to persist the query input in source\ncontrol."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'buck2 cquery "testsof(deps(%s))" @/path/to/args-file\n'})}),"\n",(0,t.jsxs)(n.p,{children:["If you want to include all the targets in the ",(0,t.jsx)(n.code,{children:"@"}),'-file in a single query\nexecution, you can use the following alternative syntax. Note the addition of\nthe capital "S" in ',(0,t.jsx)(n.code,{children:"%Ss"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'buck2 cquery "testsof(deps(%Ss))" @/path/to/args-file\n'})}),"\n",(0,t.jsxs)(n.p,{children:["In the example above, the lines of the file are converted to a set and\nsubstituted for the ",(0,t.jsx)(n.code,{children:"%Ss"}),". In addition, each line's contents are singly quoted.\nIn the example above, if the args file contains the following:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"//foo:bar\n//foo:baz\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then the query expression is equivalent to:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"buck2 cquery \"testsof(deps(set('//foo:bar' '//foo:baz')))\"\n"})}),"\n",(0,t.jsx)(n.h2,{id:"query-environments",children:"Query Environments"}),"\n",(0,t.jsx)(n.p,{children:"Buck2 provides different query environments that operate on different graph\nrepresentations:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Uquery (Unconfigured Query)"}),": Operates on the unconfigured target graph.\nUse this when you want to query targets before configurations are applied. See\n",(0,t.jsx)(n.a,{href:"/docs/concepts/glossary#unconfigured-graph",children:"unconfigured graph"})," for more details."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Cquery (Configured Query)"}),": Operates on the configured target graph where\n",(0,t.jsx)(n.code,{children:"select()"})," statements are resolved and configurations are applied. Use this\nwhen you need to understand the actual build graph. See\n",(0,t.jsx)(n.a,{href:"/docs/concepts/glossary#configured-graph",children:"configured graph"})," for more details."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Aquery (Action Query)"}),": Operates on the action graph, which represents the\nactual build actions that will be executed. See\n",(0,t.jsx)(n.a,{href:"/docs/concepts/glossary#action-graph",children:"action graph"})," for more details."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Each query environment supports a different set of operators. Refer to the\nspecific command documentation for details on which operators are available in\neach environment."}),"\n",(0,t.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/users/cheat_sheet",children:"Buck2 Cheat Sheet"})," for practical query examples"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/concepts/glossary",children:"Glossary"})," for definitions of key concepts"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/concepts/target_pattern",children:"Target Patterns"})," for more on specifying targets"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>a});var s=r(96540);const t={},o=s.createContext(t);function i(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);