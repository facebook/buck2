"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[76356],{28453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>o});var a=s(96540);const r={},t=a.createContext(r);function i(e){const n=a.useContext(t);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(t.Provider,{value:n},e.children)}},43707:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"rule_authors/custom_macros","title":"Macros","description":"It is possible to define Starlark functions that have the side-effect of","source":"@site/../docs/rule_authors/custom_macros.md","sourceDirName":"rule_authors","slug":"/rule_authors/custom_macros","permalink":"/docs/rule_authors/custom_macros","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"custom_macros","title":"Macros"},"sidebar":"main","previous":{"title":"Configuration Transitions","permalink":"/docs/rule_authors/configuration_transitions"},"next":{"title":"Dynamic Dependencies","permalink":"/docs/rule_authors/dynamic_dependencies"}}');var r=s(74848),t=s(28453);const i={id:"custom_macros",title:"Macros"},o="Macros",c={},l=[{value:"On this page",id:"on-this-page",level:2},{value:"How to define a macro",id:"defining",level:2},{value:"Compound build rules: macros that expand to multiple rules",id:"compound-targets",level:2},{value:"How to view expanded macros",id:"viewing",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"macros",children:"Macros"})}),"\n",(0,r.jsxs)(n.p,{children:["It is possible to define Starlark functions that have the side-effect of\ncreating build targets. Such functions are called ",(0,r.jsx)(n.em,{children:"macros"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"on-this-page",children:"On this page"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#defining",children:"How to define a macro"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#compound-targets",children:"Compound build targets: macros that expand to multiple targets"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#viewing",children:"How to view expanded macros"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#naming",children:"Use naming conventions to distinguish macros"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"defining",children:"How to define a macro"}),"\n",(0,r.jsxs)(n.p,{children:["We require that you define and maintain your macros in files that are external\nto your build files. These files must have an extension; we recommend that you\nuse the extension, ",(0,r.jsx)(n.code,{children:".bzl"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["To make your macros accessible to a build file, import them using the ",(0,r.jsx)(n.code,{children:"load()"}),"\nfunction."]}),"\n",(0,r.jsxs)(n.p,{children:["In the following example, the macro ",(0,r.jsx)(n.code,{children:"java_library_using_guava"}),", defined in the\nfile ",(0,r.jsx)(n.code,{children:"java_macros.bzl"}),", invokes a macro named ",(0,r.jsx)(n.code,{children:"java_library"})," that depends on the\nGoogle Guava libraries."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"java_macros.bzl"})})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"def java_library_using_guava(\n    name,\n    srcs=[],\n    resources=[],\n    deps=[],\n    visibility=[]):\n  java_library(\n    name = name,\n    srcs = srcs,\n    resources = resources,\n    deps = [\n      # This assumes this is where Guava is in your project.\n      '//third_party/java/guava:guava',\n    ] + deps,\n    visibility = visibility,\n  )\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Instantiating this macro looks the same as defining a built-in build rule. In\nthe following code, we assume that ",(0,r.jsx)(n.code,{children:"java_macros.bzl"})," is stored in the\nsubdirectory ",(0,r.jsx)(n.code,{children:"libs/java_libs/team_macros"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"#\n# load the macro from the external file\n#\nload(\"//libs/java_libs/team_macros:java_macros.bzl\", \"java_library_using_guava\")\n\n#\n# Calling this function has the side-effect of creating\n# a java_library() rule named 'util' that depends on Guava.\n#\njava_library_using_guava(\n  name = 'util',\n  # Source code that depends on Guava.\n  srcs = glob(['*.java']),\n)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"compound-targets",children:"Compound build rules: macros that expand to multiple rules"}),"\n",(0,r.jsx)(n.admonition,{type:"caution",children:(0,r.jsx)(n.p,{children:"While this is supported we strongly recommend you instead write user\ndefined rules since complex macros have performance and maintainability\ndrawbacks."})}),"\n",(0,r.jsx)(n.p,{children:"You can also create more sophisticated macros that expand into multiple build\nrules. For example, you could create a macro that produces targets for both\ndebug and release versions of an APK:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"def create_apks(\n    name,\n    manifest,\n    debug_keystore,\n    release_keystore,\n    proguard_config,\n    deps):\n\n  # This loop will create two android_binary rules.\n  for type in [ 'debug', 'release' ]:\n    # Select the appropriate keystore.\n    if type == 'debug':\n      keystore = debug_keystore\n    else:\n      keystore = release_keystore\n\n    android_binary(\n      # Note how we must parameterize the name of the\n      # target so that we avoid creating two build\n      # targets with the same name.\n      name = '%s_%s' % (name, type),\n      manifest = manifest,\n      keystore = keystore,\n      package_type = type,\n      proguard_config = proguard_config,\n      deps = deps,\n      visibility = [\n        'PUBLIC',\n      ],\n    )\n"})}),"\n",(0,r.jsxs)(n.p,{children:["As in the previous example, instantiating this macro ",(0,r.jsx)(n.em,{children:"looks"})," the same as\nspecifying a single rule:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"create_apks(\n  name = 'messenger',\n  manifest = 'AndroidManifest.xml',\n  debug_keystore = '//keystores:debug',\n  release_keystore = '//keystores:prod',\n  proguard_config = 'proguard.cfg',\n  deps = [\n    # ...\n  ],\n)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["However, instantiating this macro actually creates ",(0,r.jsx)(n.em,{children:"two"})," targets. For example,\nif you instantiated this macro in the build file, ",(0,r.jsx)(n.code,{children:"apps/messenger/BUCK"}),", it\nwould create the following rules:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"//apps/messenger:messenger_debug\n//apps/messenger:messenger_release\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Note, though, that in this scenario, the following is ",(0,r.jsx)(n.strong,{children:"NOT"})," a target:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"//apps/messenger:messenger              # MACRO, NOT A TARGET\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Therefore, the following commands do not work, which could be confusing for\ndevelopers who don't realize that ",(0,r.jsx)(n.code,{children:"messenger"})," is a macro rather than a target."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"buck build //apps/messenger:messenger    # FAILS\nbuck targets --type create_apks          # FAILS\n"})}),"\n",(0,r.jsx)(n.h2,{id:"viewing",children:"How to view expanded macros"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"buck targets"})," to view the resulting targets after expanding all macros. The\nfollowing invocation of ",(0,r.jsx)(n.code,{children:"buck targets"})," show the resulting targets from the\npreceding example, but not the macro that created them."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"buck targets fbsource//fbandroid/apps/messenger/...\n"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);