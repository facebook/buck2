# Rule writing tips

## Rule's attributes
```bash
buck audit ruletypes --specs --json
```
command from buck1 returns rule types and their specification in the json format.

Buck2 stores the output of the above command in the [attributes.bzl](https://www.internalfb.com/code/fbsource/fbcode/buck2/prelude/attributes.bzl)

### Modifying attributes
By default, buck2 will load attributes' definition from `attributes.bzl` file specified above.
If one wants to modify a type of the attribute generated from buck1 then one needs to find a place where `extra_attributes` for your rule is defined.

Starting point is `prelude.bzl` that loads `rules.bzl` which loads `rules_impl.bzl`.

For example java language rules are defined in `java.bzl` file that is imported into [rules_impl.bzl](https://www.internalfb.com/code/fbsource/[2a484ab88689fa5279f70e998a996f732d277663]/fbcode/buck2/prelude/rules_impl.bzl?lines=35%2C155%2C505)

#### Example of changing attribute type:

`javac` attribute type has been changed from `source` type into `one_of(dep, source)`

  * `attributes.bzl` [sets](https://www.internalfb.com/code/fbsource/[6c2955c9092258ac145d8378f2e8d9c02b90e16f]/fbcode/buck2/prelude/attributes.bzl?lines=2154) `"javac": attrs.option(attrs.source(), default = None)`

  * `java.bzl` [overrides](https://www.internalfb.com/code/fbsource/[1831a8883e65c2f81e78bbbd874e9d1a6cc6ad47]/fbcode/buck2/prelude/java/java.bzl?lines=69) `"javac": attrs.option(attrs.one_of(attrs.dep(), attrs.source()), default = None)`

New attribute type may require some special [handling](https://www.internalfb.com/code/fbsource/[1831a8883e65c2f81e78bbbd874e9d1a6cc6ad47]/fbcode/buck2/prelude/java/java_library.bzl?lines=288%2C296%2C299).

#### Example of adding a default value:
* set `True` as a default value for [generate_abi](https://www.internalfb.com/code/fbsource/[1831a8883e65c2f81e78bbbd874e9d1a6cc6ad47]/fbcode/buck2/prelude/java/java.bzl?lines=84) in `prebuilt_jar` rule.

### Check target and its attributes
Build targets could be generated by a bunch of bzl macros that making it hard to figure out which attributes were populated and what values they have.

Ex. fbcode repo has `thrift_library` function that will create a bunch of buck's native rules.
[An example of the target defined as thrift_library](https://www.internalfb.com/code/fbsource/[72f44557689b36e3fd5c66740d389835d1f3163d]/fbcode/actions/TARGETS?lines=7%2C19)

To find out which targets were generated one could use `buck2 targets` command and reveal all targets inside the package
```bash
buck2 targets fbcode//actions:
```
Then use the  specific target to find out all attributes:
```bash
buck2 targets --json fbcode//actions:actions-java-swift
```

* `buck  targets --json <your target>` - buck1 command
* `buck2 targets --json <your target>` - buck2 command

**NOTE:** It could be a difference in output between buck1 and buck2. buck2 could append rule with extra fields that usually start with `_` prefix.
For example for `fbcode//actions:actions-java-swift` these fields are `_java_toolchain` and `__dex_toolchain`.

### How to figure out a set of values for a specific attribute
* For example : non-empty `proguard_config` attribute in any of `java_library` that is dependency of `fb4a` application:

    ```
    buck cquery "attrregexfilter(proguard_config, '.+', kind('java_library', deps('fb4a')))" | pastry
     ```
### Invoking `glob` function on the loading phase
For example, if we have an attribute that references a directory then `glob` function should be applied in the loading phase to expand the directory into a collection of artifacts that later would be used in the rule's implementation.

Ex: [meta_inf_directory](https://buck.build/rule/java_binary.html#meta_inf_directory) attribute of `java_binary`.

To handle a situation like that one could define a special entry point into a rule that would be called during the loading phase:
[prelude.bzl and java_binary_macro_impl](https://www.internalfb.com/code/fbsource/[d984e970688327c5f9fc4cf23ae61ee7a58f86be]/fbcode/buck2/prelude/prelude.bzl?lines=13%2C87-91%2C105)

Then `java_binary_macro_impl` applies `glob` function and stores the result in the `meta_inf_directory` attribute of `java_binary_rule`: [Code pointer](https://www.internalfb.com/code/fbsource/[2a484ab88689fa5279f70e998a996f732d277663]/fbcode/buck2/prelude/java/java_binary.bzl?lines=55)

### How to invoke a custom script
The way one could include a custom script into the rule's implementation is to declare a reference to a script's binary into the rule's toolchain.

Example `compile_and_package.py` used for java programming language and responsible for invoking java compiler and collecting compilation results into a final jar.
By merging these two functions into one script we allowed them to run inside the same RE worker, where otherwise compilation results would be uploaded into RE storage (CAS) and then downloaded into another RE worker for packaging to a final artifact.
Also having a custom script allows using programming language features that are missing in the rule's Starlark API like accessing the filesystem.
For example, `compile_and_package.py` allowed implementing `remove_classes` attribute by filtering the compilation result before packaging the final artifact (requires walking over output directory and removing blocklisted files).

A way to link a custom script into java rule is to define `JavaToolchainInfo` provider with a field that represents a custom script:
[compile_and_package](https://www.internalfb.com/code/fbsource/[46e82499dd94402024a9124d384d406b9ba34794]/fbcode/buck2/prelude/java/java_toolchain.bzl?lines=14)
and then populate this field in the `config_backed_java_toolchain` rule's implementation.

[java_toolchains.bzl](https://www.internalfb.com/code/fbsource/[46e82499dd94402024a9124d384d406b9ba34794]/fbcode/buck2/platform/java_toolchains.bzl?lines=22%2C55%2C72)
`config_backed_java_toolchain` is invoked from the BUCK file [fbsource/xplat/buck2/platform/java/BUCK.v2](https://www.internalfb.com/code/fbsource/[8ee8822f897c3d89d124c23836b6db4fbd65eb34]/xplat/buck2/platform/java/BUCK.v2?lines=4).

Responsibility of choosing a specific BUCK file (by applying `select`) is inside `_select_java_toolchain()` function. The result is stored in the `_java_toolchain` attribute:  [java rules](https://www.internalfb.com/code/fbsource/[46e82499dd94402024a9124d384d406b9ba34794]/fbcode/buck2/prelude/java/java.bzl?lines=76).

### Use configuration stored in .buckconfig

```bash
buck2 audit config <configuration_group / configuration_group.specific_key / configuration_group(s)>
```
Ex: `buck2 audit config java tools` - reads and returns `[java]` and `[tools]` section values.

Then these configuration settings could be used for specifying params in the toolchains.

Ex. `bootclasspath_7` in the [java toolchain](https://www.internalfb.com/code/fbsource/[9a001bcf6929e01d93dfb7ae6bb9371f19e54ad3]/fbcode/buck2/platform/java_toolchains.bzl?lines=12%2C28%2C37%2C52%2C69)


**NOTE:** `.buckconfig` is repo specific, so `select()` function should be used to read an [appropriate buck config](https://www.internalfb.com/code/fbsource/[9a001bcf6929e01d93dfb7ae6bb9371f19e54ad3]/fbcode/buck2/prelude/java/java.bzl?lines=17).

### How to reuse buck1 code
Ex. `zip_file` rule's implementation is reused from buck1 by extracting logic into a `java_binary` and storing as `create_zip `attribute in the [zip file toolchain](https://www.internalfb.com/code/fbsource/[e668591599fa6883e2f245650442e9422b8cec27]/fbcode/buck2/platform/zip_file_toolchains.bzl?lines=4)


Check [zip_file implementation](https://www.internalfb.com/code/fbsource/[e668591599fa6883e2f245650442e9422b8cec27]/fbcode/buck2/prelude/zip_file/zip_file.bzl?lines=13-14%2C25%2C54%2C56) for more details.

## Migration of an existing rule from buck1 to buck2
Let's imagine we want to migrate `prebuilt_jar` rule.

1. Find a rule in buck1 (an instance of BuildRule interface). [PrebuiltJar](https://www.internalfb.com/code/fbsource/[1a7dbb2e900a7abd3189322fed097e0ad8e397bd]/xplat/build_infra/buck_client/src/com/facebook/buck/jvm/java/PrebuiltJar.java?lines=75)
1. Find a way how the rule is instantiated. Usually, that is a constructor call in the *Description class. [new PrebuiltJar(...)](https://www.internalfb.com/code/fbsource/[1a7dbb2e900a7abd3189322fed097e0ad8e397bd]/xplat/build_infra/buck_client/src/com/facebook/buck/jvm/java/PrebuiltJarDescription.java?lines=80-81)
1. Check `Class<T> getConstructorArgType()` implementation in the Description class. Fields from `*DescriptionArg` class are converted to `attributes.bzl`. Check how they are used (if not used then feel free to remove and regenerate `attributes.bzl`). In case some fields have default values (as overridden default method) then use `Example of adding a default value` section to extend an attribute for buck2. [PrebuiltJarDescriptionArg](https://www.internalfb.com/code/fbsource/[1a7dbb2e900a7abd3189322fed097e0ad8e397bd]/xplat/build_infra/buck_client/src/com/facebook/buck/jvm/java/PrebuiltJarDescription.java?lines=63)
1. Rule's `SortedSet<BuildRule> getBuildDeps()` should be turned into buck2's providers.
    *  for java rules this should be [JavaLibraryInfo](https://www.internalfb.com/code/fbsource/[1a7dbb2e900a7abd3189322fed097e0ad8e397bd]/fbcode/buck2/prelude/java/java_providers.bzl?lines=22) that represents:
        * library output (library.jar and abi.jar)
        * dependency for compilation (ex. it could be abi.jar of dependent targets, maybe some transitive targets, and so on)
        * dependency for packaging (ex. only full library.jar of all transitive dependencies)
        * native dependencies
1. Check `ImmutableList<? extends Step> getBuildSteps(BuildContext context, BuildableContext buildableContext)` method and actions (Steps) it returns. These actions should be migrated into the new rule's starlark implementation in buck2.
    * Check how every attribute from `BuildRuleArg` (from step 3) is used in the rule's implementation.
1. `SourcePath getSourcePathToOutput()` should be turned into `DefaultInfo`'s output.
1. Implement unit tests. Ex: [prebuilt_jar tests](https://www.internalfb.com/code/fbsource/fbcode/buck2/tests/targets/rules/java/prebuilt_jar/TARGETS.v2)



Debugging
===
### Starlark

[Working with starlark](developers.md#working-with-starlark)

[Starlark spec](https://github.com/bazelbuild/starlark/blob/master/spec.md)


* To check the type of an item in the list (ex. attribute `srcs` of list type):
  `print("srcs type={}".format(type(srcs[0])))`


### Run rule's tests locally on Mac
If run on Mac then need to add `--fake-host=linux` param to ask buck2 to use linux RE workers

`buck2 kill` to make sure we will use a new buck daemon with a fresh state.

`BUCK_LOG=info` to see the RE command line and RE action digest .

Ex. java rules tests:
```bash
buck2 kill && BUCK_LOG=info buck2 build --fake-host=linux fbcode//buck2/tests/targets/rules/java/library:
```

### Download and retry RE command locally
Every action scheduled to run on RE has an action digest( ex. a4d6c1567f2d7842af00bcddb706d72d3ec232b8:94)

Using `frecli` we could obtain the command, directory with input files, expected output, etc.

For example: If we want to debug the action locally then
executing `frecli cas download-action <action_digest>` and `cd <downloaded_directory>`

One could execute `./exe` script to rerun action locally, or prepare own command by extending it with new values for experimenting/debugging.

For example: prepare a command that would be run locally (maybe required creating a couple of temp directories for outputs, figuring out the local path to compiler tool, etc.)
Consider adding some debug params into the command (ex: `-XprintRounds -XprintProcessorInfo` to debug java annotation processors). As an example let's use `buck//src/com/facebook/buck/features/gwt:gwt` target:

    rm -rf /tmp/generated_src && mkdir -p /tmp/generated_src && rm -rf /tmp/classes_output && mkdir -p /tmp/classes_output

    /usr/local/java-runtime/impl/11/bin/javac \
    @buck-out/v2/gen/buck/9b18309f740fa745/src/com/facebook/buck/features/gwt/__gwt__/javac_args \
    -classpath @buck-out/v2/gen/buck/9b18309f740fa745/src/com/facebook/buck/features/gwt/__gwt__/classpath_args  \
    -processorpath @buck-out/v2/gen/buck/9b18309f740fa745/src/com/facebook/buck/features/gwt/__gwt__/plugin_cp_args \
    -s /tmp/generated_src \
    -d /tmp/classes_output \
    -XprintRounds -XprintProcessorInfo
