"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[46300],{28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var s=t(96540);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}},34497:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"prelude/rules/core/worker_tool","title":"worker_tool","description":"Some external tools have high startup costs. To amortize those costs over the whole build rather than paying them for each rule invocation, use the worker_tool() rule in conjunction with genrule(). Buck then starts the external tool once and reuses it by communicating with it over stdin and stdout using a simple JSON protocol.","source":"@site/../docs/prelude/rules/core/worker_tool.md","sourceDirName":"prelude/rules/core","slug":"/prelude/rules/core/worker_tool","permalink":"/docs/prelude/rules/core/worker_tool","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"ruleSidebar","previous":{"title":"versioned_alias","permalink":"/docs/prelude/rules/core/versioned_alias"},"next":{"title":"zip_file","permalink":"/docs/prelude/rules/core/zip_file"}}');var r=t(74848),i=t(28453);t(56289);const o={},l="worker_tool",c={},a=[{value:"Details",id:"details",level:3},{value:"Function Signature",id:"function-signature",level:3},{value:"Parameters",id:"parameters",level:3},{value:"Examples",id:"examples",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"worker_tool",children:"worker_tool"})}),"\n",(0,r.jsxs)(n.p,{children:["Some external tools have high startup costs. To amortize those costs over the whole build rather than paying them for each rule invocation, use the ",(0,r.jsx)(n.code,{children:"worker_tool()"})," rule in conjunction with ",(0,r.jsx)(n.code,{children:"genrule()"}),". Buck then starts the external tool once and reuses it by communicating with it over ",(0,r.jsx)(n.code,{children:"stdin"})," and ",(0,r.jsx)(n.code,{children:"stdout"})," using a simple JSON protocol."]}),"\n",(0,r.jsx)(n.h3,{id:"details",children:"Details"}),"\n",(0,r.jsxs)(n.p,{children:["A ",(0,r.jsx)(n.code,{children:"worker_tool"})," rule can be referenced in the ",(0,r.jsx)(n.code,{children:"cmd"})," parameter of\na ",(0,r.jsx)(n.code,{children:"genrule"})," by using the macro:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"$(exe //path/to:target)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"function-signature",children:"Function Signature"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def worker_tool(\n    *,\n    name: str,\n    default_target_platform: None | str = None,\n    target_compatible_with: list[str] = [],\n    compatible_with: list[str] = [],\n    exec_compatible_with: list[str] = [],\n    visibility: list[str] = [],\n    within_view: list[str] = ["PUBLIC"],\n    metadata: OpaqueMetadata = {},\n    tests: list[str] = [],\n    modifiers: OpaqueMetadata = [],\n    _apple_platforms: dict[str, str] = {},\n    _worker_tool_runner: str = "prelude//js/worker_runner:worker_tool_runner",\n    args: str | list[str] = [],\n    contacts: list[str] = [],\n    default_host_platform: None | str = None,\n    env: dict[str, str] = {},\n    exe: None | str = None,\n    labels: list[str] = [],\n    licenses: list[str] = [],\n    max_workers: None | int = None,\n    max_workers_per_thread_percent: None | int = None,\n    persistent: None | bool = None,\n) -> None\n'})}),"\n",(0,r.jsx)(n.h3,{id:"parameters",children:"Parameters"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"name"}),": (required)"]}),"\n",(0,r.jsx)(n.p,{children:"name of the target"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"default_target_platform"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"None"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"specifies the default target platform, used when no platforms are specified on the command line"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"target_compatible_with"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"a list of constraints that are required to be satisfied for this target to be compatible with a configuration"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"compatible_with"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"a list of constraints that are required to be satisfied for this target to be compatible with a configuration"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"exec_compatible_with"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"a list of constraints that are required to be satisfied for this target to be compatible with an execution platform"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"visibility"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"a list of visibility patterns restricting what targets can depend on this one"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"within_view"}),": (defaults to: ",(0,r.jsx)(n.code,{children:'["PUBLIC"]'}),")"]}),"\n",(0,r.jsx)(n.p,{children:"a list of visibility patterns restricting what this target can depend on"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"metadata"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"{}"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"a key-value map of metadata associated with this target"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"tests"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"a list of targets that provide tests for this one"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"modifiers"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"an array of modifiers associated with this target"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"args"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["A string of args that is passed to the executable represented by ",(0,r.jsx)(n.code,{children:"exe"})," on initial startup."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"contacts"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"A list of organizational contacts for this rule. These could be individuals who you would contact in the event of a failure or other issue with the rule."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"contacts = [ 'Joe Sixpack', 'Erika Mustermann' ]\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"env"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"{}"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["A map of environment variables that is passed to the executable represented by ",(0,r.jsx)(n.code,{children:"exe"})," on initial startup."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"exe"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"None"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["A ",(0,r.jsx)(n.code,{children:"build target"})," for a rule that outputs an executable, such as an ",(0,r.jsx)(n.code,{children:"sh_binary()"}),". Buck runs this executable only once per build."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"labels"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["Set of arbitrary strings which allow you to annotate a ",(0,r.jsx)(n.a,{href:"https://buck2.build/docs/concepts/build_rule/",children:"build rule"})," with tags that can be searched for over an entire dependency tree using ",(0,r.jsx)(n.code,{children:"buck query()"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"licenses"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"[]"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["Set of license files for this library. To get the list of license files for a given build rule and all of its dependencies, you can use ",(0,r.jsx)(n.a,{href:"https://buck2.build/docs/users/commands/query/",children:"buck query"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"max_workers"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"None"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["The maximum number of workers of this type that Buck starts. Use ",(0,r.jsx)(n.code,{children:"-1"})," to allow the creation of as many workers as necessary."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"max_workers_per_thread_percent"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"None"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["The maximum ratio of workers of this type that Buck starts per thread, specified as a positive integer percentage (1-100). Must be greater than or equal to ",(0,r.jsx)(n.code,{children:"1"})," and less than or equal to ",(0,r.jsx)(n.code,{children:"100"}),". Only one of ",(0,r.jsx)(n.code,{children:"max_workers"})," and ",(0,r.jsx)(n.code,{children:"max_workers_per_thread_percent"})," may be specified."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"persistent"}),": (defaults to: ",(0,r.jsx)(n.code,{children:"None"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"If set to true, Buck does not restart the tool unless the tool itself changes. This means the tool persists across multiple Buck commands without being shut down and may see the same rule being built more than once. Be careful not to use this setting with tools that don't expect to process the same input\u2014with different contents\u2014twice!"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"examples",children:"Examples"}),"\n",(0,r.jsxs)(n.p,{children:["Consider the following ",(0,r.jsx)(n.code,{children:"build rules"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\n#\n# Buck\n#\nworker_tool(\n  name = 'ExternalToolWorker',\n  exe = ':ExternalTool',\n  args = '--arg1 --arg2'\n)\n\nsh_binary(\n  name = 'ExternalTool',\n  main = 'external_tool.sh',\n)\n\ngenrule(\n  name = 'TransformA',\n  out = 'OutputA.txt',\n  cmd = '$(exe :ExternalToolWorker) argA',\n)\n\ngenrule(\n  name = 'TransformB',\n  out = 'OutputB.txt',\n  cmd = '$(exe :ExternalToolWorker) argB',\n)\n\ngenrule(\n  name = 'TransformC',\n  out = 'OutputC.txt',\n  cmd = '$(exe :ExternalToolWorker) argC',\n)\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:["When doing a ",(0,r.jsx)(n.code,{children:"buck build"})," on all three of the above ",(0,r.jsx)(n.code,{children:"genrules"}),", Buck\nfirst creates the worker process by invoking:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\n./external_tool.sh --arg1 --arg2\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Buck then communicates with this process using JSON over ",(0,r.jsx)(n.code,{children:"stdin"}),",\nstarting with a handshake:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'\n[\n  {\n    "id": 0,\n    "type": "handshake",\n    "protocol_version": "0",\n    "capabilities": []\n  }\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Buck then waits for the tool to reply on ",(0,r.jsx)(n.code,{children:"stdout"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'\n[\n  {\n    "id": 0,\n    "type": "handshake",\n    "protocol_version": "0",\n    "capabilities": []\n  }\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Then, when building the first ",(0,r.jsx)(n.code,{children:"genrule"}),", Buck writes to ",(0,r.jsx)(n.code,{children:"stdin"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'\n  ,{\n    "id": 1,\n    "type": "command",\n    "args_path": "/tmp/1.args",\n    "stdout_path": "/tmp/1.out",\n    "stderr_path": "/tmp/1.err"\n  }\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The file ",(0,r.jsx)(n.code,{children:"/tmp/1.args"})," contains ",(0,r.jsx)(n.code,{children:"argA"}),". The tool should\nperform the necessary work for this job and then write the job's output to the files\nsupplied by Buck\u2014in this case, ",(0,r.jsx)(n.code,{children:"/tmp/1.out"})," and ",(0,r.jsx)(n.code,{children:"/tmp/1.err"}),".\nOnce the job is done, the tool should reply to Buck on ",(0,r.jsx)(n.code,{children:"stdout"})," with:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'\n  ,{\n    "id": 1,\n    "type": "result",\n    "exit_code": 0\n  }\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Once Buck hears back from the first genrule's job, it submits the second genrule's job in the\nsame fashion and awaits the response. When the build is all finished,\nBuck closes the JSON by writing to ",(0,r.jsx)(n.code,{children:"stdin"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\n]\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:["which signals the tool that it should exit after replying on ",(0,r.jsx)(n.code,{children:"stdout"})," with:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\n]\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"In this example, Buck is guaranteed to invoke"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\n./external_tool.sh --arg1 --arg2\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"only once during the build. The three jobs corresponding to the three genrules are submitted\nsynchronously to the single worker process."}),"\n",(0,r.jsxs)(n.p,{children:["Note that the ",(0,r.jsx)(n.code,{children:"id"})," values in the messages are not necessarily increasing or sequential,\nbut they do have to match between the request message and the response message of a given job as\nwell as in the initial handshake."]}),"\n",(0,r.jsx)(n.p,{children:"If the tool receives a message type it cannot interpret it should answer with:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'\n{\n  "id": &ltn>,\n  "type": "error",\n  "exit_code": 1\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"If the tool receives a message type it can interpret, but the other attributes of the\nmessage are in an inconsistent state, it should answer with:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'\n{\n  "id": &ltn>,\n  "type": "error",\n  "exit_code": 2\n}\n\n'})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);