"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[67830],{166:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"api/build/Select","title":"Select","description":"The Select type represents a conditional attribute value in Buck2.","source":"@site/../docs/api/build/Select.md","sourceDirName":"api/build","slug":"/api/build/Select","permalink":"/docs/api/build/Select","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"apiSidebar","previous":{"title":"RunInfo","permalink":"/docs/api/build/RunInfo"},"next":{"title":"TaggedCommandLine","permalink":"/docs/api/build/TaggedCommandLine"}}');var t=i(74848),l=i(28453);i(56289);const c={},r="Select",a={},o=[{value:"Constraints",id:"constraints",level:2},{value:"config_setting",id:"config_setting",level:2},{value:"target_compatible_with",id:"target_compatible_with",level:2},{value:"compatible_with",id:"compatible_with",level:2},{value:"Platform-Specific Dependencies",id:"platform-specific-dependencies",level:2},{value:"Build Mode Flags",id:"build-mode-flags",level:2},{value:"Architecture-Specific Optimizations",id:"architecture-specific-optimizations",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"select",children:"Select"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"Select"})," type represents a conditional attribute value in Buck2."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Select"})," objects are created using the ",(0,t.jsx)(n.code,{children:"select()"})," function and enable build rules to have\ndifferent attribute values based on the target's configuration.\nThis is essential for cross-platform builds and conditional compilation."]}),"\n",(0,t.jsx)(n.h1,{id:"resolution-timing",children:"Resolution Timing"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Select"})," objects are resolved during Buck2's ",(0,t.jsx)(n.strong,{children:"configuration phase"}),", which happens after\nBUCK file evaluation but before rule implementation. This means:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Starlark code in BUCK files and macro rules cannot see resolved values"}),"\n",(0,t.jsxs)(n.li,{children:["Use ",(0,t.jsx)(n.code,{children:"select_map()"})," or ",(0,t.jsx)(n.code,{children:"select_test()"})," for macro-level operations"]}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"operations",children:"Operations"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Select"})," supports the addition operator (",(0,t.jsx)(n.code,{children:"+"}),") for combining conditional values:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Combine multiple selects\ndeps = select({\n    "//config:linux": ["//lib:linux"],\n    "DEFAULT": [],\n}) + select({\n    "//config:debug": ["//debug:tools"],\n    "DEFAULT": [],\n})\n\n# Add to regular values\nflags = ["-Wall"] + select({\n    "//config:optimize": ["-O3"],\n    "DEFAULT": ["-O0"],\n})\n'})}),"\n",(0,t.jsx)(n.h1,{id:"resolution-algorithm",children:"Resolution Algorithm"}),"\n",(0,t.jsxs)(n.p,{children:["When Buck2 resolves a ",(0,t.jsx)(n.code,{children:"Select"}),":"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Evaluates each key of select options"}),"\n",(0,t.jsx)(n.li,{children:"Collects all keys that match the current configuration"}),"\n",(0,t.jsxs)(n.li,{children:["Applies ",(0,t.jsx)(n.strong,{children:"refinement"})," to choose the most specific match:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"If zero matches: Use DEFAULT or error if no DEFAULT"}),"\n",(0,t.jsx)(n.li,{children:"If one match: Use that value"}),"\n",(0,t.jsx)(n.li,{children:"If multiple matches: Select the one that is most specific"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["If ties exist (equally specific):","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Same values: OK, use that value"}),"\n",(0,t.jsx)(n.li,{children:"Different values: Error"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"select-refinement-example",children:"Select Refinement Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'config_setting(\n    name = "linux",\n    constraint_values = ["//constraints:linux"],  # 1 constraint\n)\n\nconfig_setting(\n    name = "linux-arm64",\n    constraint_values = [\n        "//constraints:linux",\n        "//constraints:arm64",  # 2 constraints - more specific\n    ],\n)\n\nmy_rule(\n    srcs = select({\n        ":linux": ["generic_linux.cpp"],\n        ":linux-arm64": ["optimized_arm64.cpp"],  # This wins when both match\n    }),\n)\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Key point"}),": Order in the dictionary doesn't matter; specificity always wins."]}),"\n",(0,t.jsx)(n.h1,{id:"configuration-system",children:"Configuration System"}),"\n",(0,t.jsx)(n.h2,{id:"constraints",children:"Constraints"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"constraint_setting"}),": Defines a configuration dimension"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'constraint_setting(name = "os")\nconstraint_setting(name = "cpu")\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"constraint_value"}),": Specific value for a dimension"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'constraint_value(name = "linux", constraint_setting = ":os")\nconstraint_value(name = "arm64", constraint_setting = ":cpu")\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"platform"}),": Collection of constraint values"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'platform(\n    name = "linux-arm64",\n    constraint_values = [":linux", ":arm64"],\n)\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"config_setting",children:"config_setting"}),"\n",(0,t.jsx)(n.p,{children:"Matches specific configuration conditions:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Match constraints\nconfig_setting(\n    name = "linux-arm",\n    constraint_values = [\n        "//constraints:linux",\n        "//constraints:arm",\n    ],\n)\n\n# Match buckconfig values\nconfig_setting(\n    name = "fastmode",\n    values = {\n        "build.fastmode": "true",\n    },\n)\n\n# Combine both\nconfig_setting(\n    name = "linux-fastmode",\n    constraint_values = ["//constraints:linux"],\n    values = {"build.fastmode": "true"},\n)\n'})}),"\n",(0,t.jsx)(n.h1,{id:"platform-selection",children:"Platform Selection"}),"\n",(0,t.jsx)(n.p,{children:"Buck2 determines the target platform through:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"--target-platforms"})," command-line flag (highest priority)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"default_target_platform"})," attribute on the target"]}),"\n",(0,t.jsx)(n.li,{children:"Cell's default platform from buckconfig"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"buck2 build //app:main --target-platforms //platforms:linux-x86_64\n"})}),"\n",(0,t.jsx)(n.h1,{id:"target-compatibility",children:"Target Compatibility"}),"\n",(0,t.jsx)(n.p,{children:"Buck2 provides two attributes for platform compatibility:"}),"\n",(0,t.jsx)(n.h2,{id:"target_compatible_with",children:"target_compatible_with"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"ALL semantics"}),": Target is compatible only if ",(0,t.jsx)(n.strong,{children:"all"})," listed constraints match:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'cxx_library(\n    name = "windows_dev_only",\n    target_compatible_with = [\n        "//constraints:windows",  # Must be Windows AND\n        "//constraints:dev",      # Must be dev mode\n    ],\n)\n'})}),"\n",(0,t.jsx)(n.h2,{id:"compatible_with",children:"compatible_with"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"ANY semantics"}),": Target is compatible if ",(0,t.jsx)(n.strong,{children:"any"})," listed constraint matches:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'cxx_library(\n    name = "unix_compatible",\n    compatible_with = [\n        "//constraints:linux",    # Linux OR\n        "//constraints:macos",    # macOS (either works)\n    ],\n)\n'})}),"\n",(0,t.jsx)(n.h1,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,t.jsx)(n.h2,{id:"platform-specific-dependencies",children:"Platform-Specific Dependencies"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'cxx_library(\n    name = "mylib",\n    srcs = ["common.cpp"],\n    deps = [\n        "//common:base",\n    ] + select({\n        "//config:linux": ["//platform:linux_support"],\n        "//config:macos": ["//platform:macos_support"],\n        "//config:windows": ["//platform:windows_support"],\n    }),\n)\n'})}),"\n",(0,t.jsx)(n.h2,{id:"build-mode-flags",children:"Build Mode Flags"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'cxx_binary(\n    name = "app",\n    compiler_flags = select({\n        "//config:debug": ["-g", "-O0"],\n        "//config:release": ["-O3", "-DNDEBUG"],\n        "DEFAULT": ["-O2"],\n    }),\n)\n'})}),"\n",(0,t.jsx)(n.h2,{id:"architecture-specific-optimizations",children:"Architecture-Specific Optimizations"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'cxx_library(\n    name = "simd",\n    compiler_flags = select({\n        "//config:x86_64": ["-msse4.2"],\n        "//config:arm64": ["-march=armv8-a"],\n        "DEFAULT": [],\n    }),\n)\n'})}),"\n",(0,t.jsx)(n.h1,{id:"working-with-selects-in-macros",children:"Working with Selects in Macros"}),"\n",(0,t.jsxs)(n.p,{children:["Since ",(0,t.jsx)(n.code,{children:"select()"})," values aren't resolved during BUCK evaluation, use these functions:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"select_map(value, func)"}),": Transform all possible values"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Add suffix to all possible values\nnew_deps = select_map(\n    deps_select,\n    lambda items: [item + "_wrapper" for item in items]\n)\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"select_test(value, func)"}),": Test if any value matches predicate"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Check if any branch has more than 2 items\nhas_many = select_test(deps_select, lambda items: len(items) > 2)\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"error-messages",children:"Error Messages"}),"\n",(0,t.jsx)(n.p,{children:"Common errors:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"No match without DEFAULT"}),': "None of N conditions matched configuration ... and no default was set"']}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Ambiguous match"}),': "Both select keys ',(0,t.jsx)(n.code,{children:"X"})," and ",(0,t.jsx)(n.code,{children:"Y"}),' match the configuration, but neither is more specific and they have different values"']}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Invalid usage"}),": Cannot use ",(0,t.jsx)(n.code,{children:"select()"})," inside config_setting or other configuration rules"]}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"see-also",children:"See Also"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"select()"})," - Creates a Select object"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"select_map()"})," - Applies a function to all possible values"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"select_test()"})," - Tests if any value passes a predicate"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"target_compatible_with"})," - Platform compatibility filtering"]}),"\n",(0,t.jsx)(n.li,{children:'Buck2 docs: "Configurations By Example"'}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>r});var s=i(96540);const t={},l=s.createContext(t);function c(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);