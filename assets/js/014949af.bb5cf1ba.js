"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[69999],{28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>d});var i=t(96540);const s={},a=i.createContext(s);function o(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(a.Provider,{value:n},e.children)}},62598:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>c,frontMatter:()=>o,metadata:()=>i,toc:()=>r});const i=JSON.parse('{"id":"rule_authors/dep_files","title":"Dep Files","description":"Dep files allow commands to declare which subset of their inputs were used when","source":"@site/../docs/rule_authors/dep_files.md","sourceDirName":"rule_authors","slug":"/rule_authors/dep_files","permalink":"/docs/rule_authors/dep_files","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"dep_files","title":"Dep Files"},"sidebar":"main","previous":{"title":"PACKAGE Files","permalink":"/docs/rule_authors/package_files"},"next":{"title":"String parameter macros","permalink":"/docs/rule_authors/string_parameter_macros"}}');var s=t(74848),a=t(28453);const o={id:"dep_files",title:"Dep Files"},d=void 0,l={},r=[{value:"Use Cases",id:"use-cases",level:2},{value:"Using dep files",id:"using-dep-files",level:2},{value:"Declaring the dep files and associating inputs",id:"declaring-the-dep-files-and-associating-inputs",level:2},{value:"Producing the dep file",id:"producing-the-dep-file",level:2},{value:"Testing dep files",id:"testing-dep-files",level:2},{value:"Extra notes to the implementer",id:"extra-notes-to-the-implementer",level:2},{value:"Limitations",id:"limitations",level:3},{value:"Dep files don&#39;t need to be covering",id:"dep-files-dont-need-to-be-covering",level:3},{value:"Dep files are lazy",id:"dep-files-are-lazy",level:3},{value:"Dep files will traverse symlinks",id:"dep-files-will-traverse-symlinks",level:2},{value:"Remote dep files",id:"remote-dep-files",level:2}];function u(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Dep files allow commands to declare which subset of their inputs were used when\nthe command executed."}),"\n",(0,s.jsx)(n.p,{children:"When a command produces a dep file and is later invalidated due to an inputs\nchange, Buck2 uses the dep file to check whether the inputs that changed were in\nthe set that the command reported as having used. If none of the inputs that\nchanged were in that set, Buck2 omits re-running the command and reuses the\nprevious result."}),"\n",(0,s.jsx)(n.h2,{id:"use-cases",children:"Use Cases"}),"\n",(0,s.jsx)(n.p,{children:"Dep files are used to make dependencies finer grained than what exists in the\ntarget graph, but they're not a substitute for avoiding unused dependencies.\nThey're often useful when targets export many outputs (such as C++ headers) that\naren't all used by all their dependents."}),"\n",(0,s.jsx)(n.p,{children:"Dep files are currently used to skip recompilation steps in C++ when an unused\nheader changed. They're also used in Java to skip recompilation when an unused\nclass changed."}),"\n",(0,s.jsx)(n.h2,{id:"using-dep-files",children:"Using dep files"}),"\n",(0,s.jsx)(n.p,{children:"To use dep files, you need to do the following:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Declare what output is a dep file and associate it with your command."}),"\n",(0,s.jsx)(n.li,{children:"Declare which inputs are covered by the dep file (this can be a subset of your\ninputs)."}),"\n",(0,s.jsx)(n.li,{children:"Have your command produce the dep file in a format Buck2 can use."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"declaring-the-dep-files-and-associating-inputs",children:"Declaring the dep files and associating inputs"}),"\n",(0,s.jsx)(n.p,{children:"To declare a dep file and associate it with your command, you need to tag your\nartifacts."}),"\n",(0,s.jsx)(n.p,{children:"Specifically, you'll tag the output (the dep file) and the inputs it covers, as\nshown in the following code:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# First, create a tag\n\nheaders_tag = ctx.actions.artifact_tag()\n\n# Then, tag inputs and the dep file itself in your command line.\n# You do this using the `tag_artifacts` method on your tag.\n# This method does not mutate the input, it wraps it, so you use the output.\n# Any command-line-arg-like can be tagged.\n\ntagged_headers = headers_tag.tag_artifacts(headers)\n\ndep_file = ctx.actions.declare_output("deps").as_output()\ntagged_dep_file = headers_tag.tag_artifacts(dep_file)\n\n# Finally, declare your action.\n# Use the tagged artifacts as you would regular command-line-arg-likes.\n# Pass the tag in `dep_files` and give a name (this is used for logging).\n\nctx.actions.run(\n  ["mycc", "-I", tagged_headers, "-MD", "-MF", tagged_dep_file, "-o", ...],\n  dep_files = { "headers": headers_tag }\n)\n\n'})}),"\n",(0,s.jsx)(n.h2,{id:"producing-the-dep-file",children:"Producing the dep file"}),"\n",(0,s.jsx)(n.p,{children:"Your command must produce dep files in the format Buck2 expects, which is simply\na list of all the inputs that were used, one per line."}),"\n",(0,s.jsx)(n.p,{children:"The paths must be the paths Buck2 would use for your inputs, which means paths\nrelative to the project root."}),"\n",(0,s.jsx)(n.p,{children:"If this is not the format your tool produces, use a wrapper to take whatever\noutput your command produces and rewrite it in the format Buck2 expects."}),"\n",(0,s.jsx)(n.h2,{id:"testing-dep-files",children:"Testing dep files"}),"\n",(0,s.jsx)(n.p,{children:"When writing a command that produces a dep file, you should test it! At a\nminimum, check that the inputs you expect are tagged properly."}),"\n",(0,s.jsxs)(n.p,{children:["To do so, build your target, then use\n",(0,s.jsx)(n.code,{children:"buck2 audit dep-files TARGET CATEGORY IDENTIFIER"}),", which will show you the set\nof inputs your command used and how they're tagged."]}),"\n",(0,s.jsx)(n.h2,{id:"extra-notes-to-the-implementer",children:"Extra notes to the implementer"}),"\n",(0,s.jsx)(n.h3,{id:"limitations",children:"Limitations"}),"\n",(0,s.jsxs)(n.p,{children:["Dep files only work if a previous invocation of the command is known to your\nBuck2 daemon. Dep files are dropped when the daemon restarts or when you run\n",(0,s.jsx)(n.code,{children:"buck2 debug flush-dep-files"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"This means that, for example, if you change an unused header, then run a build\non a fresh daemon, Buck2 will still need to execute this command in order to\nidentify that the header was in fact unused. In contrast, if you did the build\n(and got a remote cache hit on the command), then applied your change and\nre-built, Buck2 would use the dep file on the second execution, and you wouldn't\nneed to execute anything."}),"\n",(0,s.jsx)(n.h3,{id:"dep-files-dont-need-to-be-covering",children:"Dep files don't need to be covering"}),"\n",(0,s.jsx)(n.p,{children:"It's OK for the dep file to only cover a subset of the inputs of your action.\nHowever, within that subset, the dep file must declare all the inputs that were\nused."}),"\n",(0,s.jsx)(n.p,{children:"If you fail to report some inputs you used, then your command will not re-run\nwhen they change, and you'll get stale output."}),"\n",(0,s.jsx)(n.h3,{id:"dep-files-are-lazy",children:"Dep files are lazy"}),"\n",(0,s.jsx)(n.p,{children:"Dep files aren't parsed by Buck2 unless the command needs to re-run. If the\ncommand ran on RE, they aren't even downloaded until then. This ensures dep\nfiles don't cause a performance hit unless they are used, at which point they\nstand a chance of giving a performance boost instead."}),"\n",(0,s.jsxs)(n.p,{children:["This means that if you produce an invalid dep file, Buck2 will not report this\nuntil your command runs again, at which point Buck2 will report that the dep\nfile is invalid and refuse to proceed (note: you can unblock yourself using\n",(0,s.jsx)(n.code,{children:"buck2 debug flush-dep-files"}),")."]}),"\n",(0,s.jsxs)(n.p,{children:["To flush out issues during development, you can pass ",(0,s.jsx)(n.code,{children:"--eager-dep-files"})," to\nBuck2 to force Buck2 to parse your dep files as they are produced."]}),"\n",(0,s.jsx)(n.h2,{id:"dep-files-will-traverse-symlinks",children:"Dep files will traverse symlinks"}),"\n",(0,s.jsx)(n.p,{children:"If your dep file reports that a symlink was used, Buck2 will track the symlink's\ntarget as covered by this dep file."}),"\n",(0,s.jsx)(n.h2,{id:"remote-dep-files",children:"Remote dep files"}),"\n",(0,s.jsxs)(n.p,{children:['Since dep files only work if a previous invocation of the command is known to\nyour Buck2 daemon, Buck2 also supports "remote dep files". For actions with\n',(0,s.jsx)(n.code,{children:"allow_dep_file_cache_upload = True"}),", Buck2 will upload dep files to the remote\ncache. The dep file is keyed on the current version control revision, in\naddition to information about the action itself."]}),"\n",(0,s.jsx)(n.p,{children:'For those same actions, Buck2 will look for a "remote dep file", and if it finds\none it will download dep file and use it exactly as it would if it found one\nlocally (i.e. it compares the inputs to see if only unused inputs have changed\nand it can therefore skip the action execution)'})]})}function c(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}}}]);